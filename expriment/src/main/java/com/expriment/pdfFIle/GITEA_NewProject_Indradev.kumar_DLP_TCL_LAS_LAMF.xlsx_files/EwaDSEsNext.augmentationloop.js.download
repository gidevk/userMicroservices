'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[16],{1003:function(r,B,a){a.d(B,"a",function(){return e});r=a(0);var c=a(24);B=a(1004);var b=a(15);class e extends B.a{constructor(f,d,h,l){super();Object.assign(this,d);this.$=f;this.nae=h;l&&(this.iXb=l.range,this.Cyg=l.valueType);this.hda={flowId:this.flowId,SJ:this.SJ,originCell:this.originCell,anonymizedFormula:this.anonymizedFormula}}set flowId(f){this.nae=f}get flowId(){return this.nae}get formula(){var f;
void 0===this.PWa&&(this.PWa=null===(f=this.generatedFormula)||void 0===f?void 0:f.formula)&&"="!==this.PWa.charAt(0)&&(b.ULS.sendTraceTag(509620492,306,50,"FormulaByExampleSuggestion.formula: appending = sign as formula prefix."),this.PWa=`=${this.PWa}`);return this.PWa}set SJ(f){this.ALc=f}get Ecd(){return this.rows}get UMe(){return this.Cyg}get anonymizedFormula(){var f;void 0===this.xae&&(this.xae=null===(f=this.generatedFormula)||void 0===f?void 0:f.anonymizedFormula);return this.xae}get SJ(){void 0===
this.ALc&&(this.ALc=this.Ecd.length);return this.ALc}set originCell(f){this.iXb=f}get originCell(){void 0===this.iXb&&(b.ULS.sendTraceTag(509620491,306,10,`FormulaByExampleSuggestion.originCell: origin cell is not defined - falling back to first cell of annotation range. flowId: ${this.flowId}`),this.iXb=c.Range.Hc(this.Ecd[0],this.column));return this.iXb}get range(){return new c.Range(this.AO.top,this.column,this.AO.bottom,this.column,!0,!0)}xkf(f){return f.vd(this.range)&&this.Ecd.includes(f.top)}}
Object(r.a)(e,"FormulaByExampleSuggestionBase",B.a,[])},1004:function(r,B,a){a.d(B,"a",function(){return b});r=a(0);B=a(741);var c=a(718);class b extends B.a{constructor(){super();this.rows=null;this.column=0;this.generatedFormula=this.formulas=null;this.resultKind=this.invocationMethod=this.stateID=0;this.errorMessage=this.guid=null;this.H_=Object.assign(new c.a,{T_:b.getTypeName(),B_:b.Pd()})}static getTypeName(){return"AugLoop_FormulaByExample_FormulaByExampleAnnotation"}static Pd(){return["AugLoop_Core_Annotation"]}}
Object(r.a)(b,"FormulaByExampleAnnotation",B.a,[])},1005:function(r,B,a){a.d(B,"b",function(){return"<<<FBE_XL_RW>>>"});a.d(B,"a",function(){return c});r=a(0);a=a(1003);class c extends a.a{constructor(b,e,f,d,h){super(b,e,f,h);this.kind="Range";this.AO=d}get formula(){const b=super.formula;return b?b.replace(RegExp("<<<FBE_XL_RW>>>","g"),`${this.originCell.top}`):null}get AO(){return this.$Hg}set AO(b){this.$Hg=b}}Object(r.a)(c,"FormulaByExampleRangeSuggestion",a.a,[])},1185:function(r,B,a){function c(Z){return I.Range.Hc(Z.row+
1,Z.col+1)}var b=a(9);r=a(0);var e=a(15),f=a(714),d=a(50),h=a(38),l=a(1315),k=a(1),w=a(1002),n=a(256),x=a(96);class m extends w.a{constructor(Z){super(Z,m.featureName)}static init(Z){m.Ma?e.ULS.sendTraceTag(522782307,1,15,"FormulaSuggestionUIControl.init: unexpected call after already being inited."):m.Ma=new m(Z)}static instance(){return m.Ma}get ee(){return n.a.J0e}show(Z,ja,la,ua,eb,Eb=null,Wb=null){this.Zag(Wb,Ab=>{appChrome.renderFormulaSuggestionCard(Z,ja,this.domElement,Ab.y,Ab.x,Ab.y+Ab.height,
Ab.x+Ab.width,la,ua,eb,Eb,this.L8f)})}C7(Z,ja,la){k.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.FBECurtainLifterCalloutForTestingOnlyEnabled",!1)&&(this.p2a&&Z.equals(this.PCi)||(this.p2a&&document.body.removeChild(this.p2a),this.PCi=Z,Z=this.grid.Jb(Z),Z=this.grid.getCellBounds(Z.cell,!0),this.p2a=document.createElement("div"),this.p2a.setAttribute("style",`position:fixed;
        left: ${Z.x+Z.width}px;
        top: ${Z.y+Z.height/2}px`),document.body.appendChild(this.p2a)),Z=new x.a(-847286761,0,this.$.xc,0,null),this.$.Ia.Hb(Z,{["CalloutName"]:15,["Target"]:this.p2a,["NewState"]:ja,["Reason"]:la}))}}Object(r.a)(m,"FormulaSuggestionUIControl",w.a,[273]);var u=a(108),t=a(54),y=a(153);class v extends f.a{constructor(Z){super(Z)}ld(){e.ULS.sendTraceTag(528758224,0,50,"FormulaByExampleCommandHandlerFactory.CreateCommandHandlersAsync: FormulaByExampleCommandHandler init flow started.");const Z=d.GetServiceTaskFactory.Pa(this.$.da,
453,454,1);let ja;ja=k.EwaSettings.OH()?Object(u.c)(y.a.resolve(t.f,{Wb:1})):d.GetServiceTaskFactory.Pa(this.$.da,266,265,1);h.TaskExtensions.za(h.TaskExtensions.Md([Z,ja],this.ka),()=>{const la=this.$.da.Ba(328);this.fd([new l.a(this.$,la,ja.result,Z.result,m.instance())]);e.ULS.sendTraceTag(537161924,0,50,"FormulaByExampleCommandHandlerFactory.CreateCommandHandlersAsync: FormulaByExampleCommandHandler initialized successfully")},this.ka)}static la(Z){f.a.Rd(455,new v(Z))}}Object(r.a)(v,"FormulaByExampleCommandHandlerFactory",
f.a,[]);var A=a(58);w=a(228);var z=a(7),C=a(839),H=a(5),I=a(24),S=a(33),P=a(8);class D{constructor(Z,ja,la){this.kind=Z;this.value=ja;this.formatted=la}get displayText(){var Z;return null!==(Z=this.formatted)&&void 0!==Z?Z:this.value}}Object(r.a)(D,"CloneEvaluatedEdit",null,[]);class G{constructor(Z,ja=null,la){this.status=Z;this.ubd=ja;this.Ntc=la}}Object(r.a)(G,"FormulaByExampleFormulaEvalResult",null,[]);var E=a(22),O=a(21),N=a(874),J=a(62),W=a(294);class ea{constructor(Z,ja,la,ua){this.J$f=this.$kf=
this.FB=!1;this.$=Z;this.calcManager=ja;this.FB=ua;this.Zg=la;this.Uk=N.a.getInstance(this.$);this.gridView=O.h(this.$);this.$kf=k.EwaSettings.isChangeGateEnabled("OfficeVSO:6327953_FormatOutputResultsOfFBE_V2");this.J$f=k.EwaSettings.isChangeGateEnabled("OfficeVSO:7549840_DontShowFBESuggestionsWithErrorInTriggerCell")}UDj(Z,ja,la=null,ua=!1,eb){ja=Z.range.xe(ja);return ja?this.HSe(Z,ja,la).then(Eb=>{this.FB&&!ua&&Z.flowId&&Object(C.f)("CALCULATIONED",Z.flowId,eb);if(2===Eb.status)return Eb;e.ULS.sendTraceTag(537161881,
0,50,"FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: evalFormulaRangeOnClone CSE: Result received from calc.");return this.q5j(Eb,ua,Z.flowId,eb)}).catch(Eb=>{Object(C.h)(Z,`failed to setFormulaPreviewOnRangeModel, error in calc API: ${Eb.toString()}`,this.Uk,8);return Promise.reject(`FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: Unable to EvalFormulaRange, e: ${Eb.toString()}`)}):(Object(C.h)(Z,"Annotation range does not intersect loaded range",this.Uk,6),Promise.reject("FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: Annotation range does not intersect loaded range."))}HSe(Z,
ja,la=null){la=ea.DNh(la);this.Uk.vp(Z.flowId,7);return this.calcManager.B3a(la,ja,Z.originCell,Z.formula,void 0).then(ua=>{if(!this.Cti(ua))return Object(C.h)(Z,"Result object from EvalOnClone API is empty or null.",this.Uk,8),new G(2);if(!this.PTg(ua,Z))return e.ULS.sendTraceTag(527005663,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone: Formula results from Calc.ts had errors."),new G(2);const eb=this.O9j(ua,Z);if(!eb.success)return Object(C.h)(Z,`Evaluated results from calc do not match the user data in the grid or had errors from calc. reason: ${eb.reason}`,
this.Uk,8),e.ULS.sendTraceTag(537161880,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone:Formula results from Calc.ts do not match grid data."),new G(2);this.Uk.vp(Z.flowId,11);e.ULS.sendTraceTag(537161879,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone: EvalFormulaRange CSE: Result received from calc.");return new G(0,ua.results,eb.Ntc)}).catch(ua=>{Object(C.h)(Z,`failed to EvalFormulaRangeOnClone, error in calc API: ${ua.toString()}`,this.Uk,8);return Promise.reject(`FormulaByExampleModelUpdater:EvalFormulaOnRange: Unable to EvalFormulaRange, e: ${ua.toString()}`)})}HVg(Z,
ja){if(Z)for(const ua of Z)if(excelOnlineCalc.util.isSuccess(ua)){Z=ua;var la=c(Z.value[0]);if(la=this.gridView.Jb(la))la=la.cell,la.text=this.Dhd(Z).displayText,la.formulaBarText=ja}}static DNh(Z){const ja=la=>({row:la.cell.SQ,column:la.cell.RQ,Nr:la.Nr,formulaBarText:la.Nr.value,text:la.cell.text,Ci:la.cell.Ci});return Z?Z.map(ja):null}PTg(Z,ja){if(k.EwaSettings.isChangeGateEnabled("OfficeVSO:6669310_FBEShowsSuggestionsWithCalcFailures"))return!0;for(const la of Z.results){const {isSuccess:ua,ibd:eb,
reason:Eb}=this.VNh(la);if(!ua)return Object(C.h)(ja,`Calc failed to evaluate formula. reason json: ${Eb} did result in error for formula output (#VALUE, #REF etc..): ${eb}`,this.Uk,8),!1}return!0}Cti(Z){return(Z=Z.results)&&Z.length?!0:!1}VNh(Z){if(excelOnlineCalc.util.isSuccess(Z)){const ja=Z.value[1];return 8===ja.kind?(Z=c(Z.value[0]),(Z=this.gridView.Jb(Z))&&Z.cell.text&&e.ULS.shipAssertTag(537161878,0,!1,"FormulaByExampleModelUpdater:FormulaCalculationSucceeded: formula evaluation failed, bad formula provided"),
{isSuccess:!1,ibd:!0,reason:JSON.stringify(ja.type)}):{isSuccess:!0,ibd:!1,reason:null}}return{isSuccess:!1,ibd:!1,reason:JSON.stringify(Z.reason)}}q5j(Z,ja,la,ua){var eb=Z.ubd;for(const Eb of eb)excelOnlineCalc.util.isSuccess(Eb)?(eb=Eb.value[0])?(eb=c(eb),(eb=this.gridView.Jb(eb))?(eb.cell.Mbb=this.Dhd(Eb).displayText,Z.status|=1):Z.status|=2):Z.status|=2:"Unavailable"!==Eb.reason.kind&&(Z.status|=2);this.FB&&!ja&&la&&Object(C.f)("MODELUPDATED",la,ua);return Z}O9j(Z,ja){let la=null,ua=!1,eb=!1,
Eb=!1,Wb=!1,Ab=!1,Jb=!1;Z=Z.results;var Gb=Z.entries();for(const ab of Gb){Gb=ab[0];var Nb=ab[1];const wb=this.P9j(Nb,ja);if(Object(W.b)(Nb))Nb=!0;else{var Ja=Nb.value[0];if(Ja="row"in Ja&&"col"in Ja)Nb=Nb.value[1],Ja="kind"in Nb&&"value"in Nb&&"formattedText"in Nb;Nb=Ja}Nb||e.ULS.sendTraceTag(509216720,0,10,"FormulaByExampleModelUpdater:validateCalcResultMatchModelData: evalOnCloneCellResult should be kind of EvalOnCloneSuccesResultDeprecated.");wb.S8a&&(ua=wb.T8b);wb.fvd&&(eb=!0,Eb||(Eb=wb.isInViewport),
Ab||(Ab=wb.isInViewport&&!wb.ZBb));Wb||(Wb=wb.ZBb);Jb||(Jb=wb.bdf);la=null!==la&&void 0!==la?la:wb.fIa;(wb.fvd||wb.ZBb)&&Z.splice(Gb,1)}ua?this.Uk.vp(ja.flowId,10):this.Uk.vp(ja.flowId,9);return la?{success:!1,reason:la}:{success:!0,Ntc:{["hasUnavailableCells"]:eb,["hasUnexpectedUnavailableCellsInViewport"]:Ab,["hasHiddenRows"]:Wb,["hasUnavailableCellsInViewport"]:Eb,["hasErrorCells"]:Jb}}}P9j(Z,ja){var la;const ua={S8a:!1,fvd:!1,isInViewport:!1,ZBb:!1,fIa:null,bdf:!1,T8b:!1};if(!excelOnlineCalc.util.isSuccess(Z)){var eb=
Z.reason;Z=I.Range.Hc(eb.cell.row+1,eb.cell.col+1);ua.S8a=Z.equals(ja.originCell);this.jZe(ua,Z);if(k.EwaSettings.isChangeGateEnabled("OfficeVSO:6669310_FBEShowsSuggestionsWithCalcFailures")){if("Unavailable"===eb.kind)return ua.fvd=!0,ua;ua.fIa=JSON.stringify({kind:eb.kind,innerKind:eb.innerKind})}ua.fIa=null!==(la=ua.fIa)&&void 0!==la?la:"failure in calc";return ua}eb=c(Z.value[0]);ua.S8a=eb.equals(ja.originCell);this.jZe(ua,eb);la=this.gridView.Jb(eb);if(!la){if(ua.isInViewport&&!ua.ZBb)return ua.fIa=
"formatted grid cell is null",ua;e.ULS.sendTraceTag(509682371,0,50,"FormulaByExampleModelUpdater:validateCalcResultMatchesCellData: did not fail suggestion when a formatted grid cell is null as this cell is hidden or not in view.");return ua}var Eb=this.Dhd(Z,this.$kf?la:null,ja.UMe);if(8===Eb.kind)return ua.bdf=!0,this.J$f&&ua.S8a&&(ua.fIa=`suggestion has error of kind ${Eb.value} in cell.`),ua;Z=la.text;if(!Z)return ua.T8b=!0,ua;Eb=Eb.displayText;ua.T8b=E.a.equals(Z,Eb,!1);ua.T8b||(eb=ja.xkf(eb)?
ua.S8a?"MODIFIEDEXAMPLE":"EXAMPLE":ua.S8a?"MODIFIEDRESTOFRANGE":"RESTOFRANGE",Object(C.g)(Z,Eb.toString(),la.cell.Ci,"evalFormulaOnCloneToShowPreview",ja,eb),ua.fIa="data strings do not match");return ua}jZe(Z,ja){Z.isInViewport=this.gridView.gN(ja);const la=this.gridView.gk("FormulaByExample");Object(J.a)(la);Z.ZBb=la.value.rCb(ja)}uNh(Z,ja,la){Z=this.Zg.x0e(Z,ja.cell.Ci,0===ja.cell.sC?la:ja.cell.sC,ja.cell.hCa,ja.cell.Bia);if(Z.success)return Z.RA;e.ULS.sendTraceTag(509694294,0,50,"FormulaByExampleModelUpdater:formatCloneResult: formatCellsAction failed to format clone result according to cell format.");
return null}Dhd(Z,ja,la){Z=Z.value[1];var ua=1===Z.kind?Z._valueXL.toString():8===Z.kind?P.a.jbd[Z.type-1]:Z.value;ja&&!Z.formattedText&&(Z.formattedText=this.uNh(ua,ja,la));return new D(Z.kind,ua,Z.formattedText)}}Object(r.a)(ea,"FormulaByExampleModelUpdater",null,[]);var R=a(273),Y=a(1004),U=a(71),da=a(180),T=a(182),ka=a(1003);class L extends ka.a{constructor(Z,ja,la,ua){super(Z,ja,la,ua);this.kind="Table"}get table(){void 0===this.Onb&&(this.Onb=Object(O.h)(this.$).tb.uh(this.originCell,!1));return this.Onb}get AO(){return this.table?
Object(T.a)(this.table):null}}Object(r.a)(L,"FormulaByExampleTableSuggestion",ka.a,[]);var fa=a(1005),wa=a(128),oa;(function(Z){Z.accept="ACCEPT";Z.undo="UNDO";Z.decline="DECLINE";Z.ignore="IGNORE"})(oa||(oa={}));Object(r.b)("PreviewOutcome",oa);var xa;(xa||(xa={})).unseen="UNSEEN";Object(r.b)("EntryState",xa);const bb=Object.assign(Object.assign({},xa),oa);class Za{constructor(Z){this.state=bb.unseen;this.DMb=0;this.suggestion=Z}bji(){this.DMb+=1}}Object(r.a)(Za,"SuggestionEntryInternal",null,[]);
class La extends Map{Mha(Z){const ja=this.kka(Z);if(!ja)return null;let la=this.get(ja);la||(la=[],this.set(ja,la));Z=new Za(Z);la.push(Z);return Z}wub(Z){const ja=this.lka(Z);ja&&(Z=this.kka(Z),Z=this.get(Z),Z.splice(Z.indexOf(ja)))}Dng(Z){const ja=this.lka(Z);ja&&(ja.suggestion=Z);return ja}}Object(r.a)(La,"SuggestionsCache",Map,[]);class va extends La{iYh(Z){var ja;return null===(ja=super.get(Z))||void 0===ja?void 0:ja[0]}lka(Z){return(Z=this.kka(Z))?this.has(Z)?this.get(Z)[0]:null:null}Mha(Z){const ja=
this.kka(Z);if(!ja)return null;Z=new Za(Z);this.set(ja,[Z]);return Z}wub(Z){(Z=this.kka(Z))&&this.delete(Z)}}Object(r.a)(va,"SingularSuggestionsCache",La,[]);var Ba=a(894),Ea=a(1006),pa=a(893),$a=a(429);class cb extends La{constructor(Z){super();this.hF=Z}Mha(Z){const ja=this.Dng(Z);if(ja)return ja;this.hF.C7(Z.originCell,3);return super.Mha(Z)}lka(Z){return this.g0h(Z.range)}g0h(Z){var ja;e.ULS.shipAssertTag(509383498,306,Z.Fg,"FormulaByExampleRangeSuggestionsCache.getIntersectingSuggestion: lookup range must be of single column width.");
return null===(ja=this.get(Z.left))||void 0===ja?void 0:ja.find(la=>la.suggestion.range.vd(Z))}kka(Z){return Z.column}}Object(r.a)(cb,"FormulaByExampleRangeSuggestionsCache",La,[]);class ib extends va{constructor(Z,ja){super();this.calcManager=Z;this.hF=ja}Mha(Z){var ja;let la=!1;const ua=super.lka(Z);if(!ua||(la=ua.suggestion.formula!==Z.formula))return la&&e.ULS.sendTraceTag(523842004,306,20,`FormulaByExampleSuggestionsCache.cacheSuggestion: formula changed from last cache entry, overriding cache entry.
           Last example count: ${ua.suggestion.SJ}, current: ${Z.SJ}, oldFormula: ${ua.suggestion.anonymizedFormula}, newFormula:${Z.anonymizedFormula}`),e.ULS.sendTraceTag(537161877,306,20,`FormulaByExampleSuggestionsCache.cacheSuggestion: saving suggestion for table range. tableRange: ${null===(ja=Z.table)||void 0===ja?void 0:ja.usedRange}, columnNumber: ${Z.column}, examplesCount ${Z.SJ}, hasPreviousSuggestion: ${this.has(this.kka(Z))}`),(ja=super.Mha(Z))||e.ULS.sendTraceTag(528889932,306,15,"SuggestionsCache.cacheSuggestion: failed to cache table suggestion due to getTableColumnKey failure."),
this.hF.C7(Z.originCell,3),ja;ua.suggestion.SJ!==Z.SJ&&(e.ULS.sendTraceTag(523842003,306,50,`FormulaByExampleSuggestionsCache.cacheSuggestion: formula didn't change from the last cache entry, but number of examples changed. Last example ${ua.suggestion.SJ}, current: ${Z.SJ}`),this.hF.C7(Z.originCell,4),Z.hda.SJ=ua.suggestion.hda.SJ);return this.Dng(Z)}lka(Z){const ja=super.lka(Z);return E.a.equals(null===ja||void 0===ja?void 0:ja.suggestion.formula,Z.formula,!0)?ja:null}F8h(Z,ja){Z=this.L$e(Z,ja);
return Z?this.iYh(Z):(e.ULS.sendTraceTag(528889931,306,15,"FormulaByExampleSuggestionsCache.getTableCachedSuggestion: failed to get cached table suggestion due to getTableColumnKey failure."),null)}kka(Z){return this.L$e(Z.table,Z.column)}L$e(Z,ja){const la=this.calcManager.Gec(Z);if(!la)return null;const ua=Z.usedRange,eb=ja-ua.left;return 0>eb||eb>=la.count?(e.ULS.sendTraceTag(537161876,306,10,`FormulaByExampleSuggestionCache.getUniqueTableColumnIdentifier: invalid inputs. tableRange: ${ua}, columnNumber: ${ja}, `+
`areAllTableHeadersAvailable: ${this.calcManager.STg(Z,la)}`),null):(ja=la.ma(eb))?Z.name+"_"+ja:null}}Object(r.a)(ib,"FormulaByExampleTableSuggestionsCache",va,[]);class ta extends Set{constructor(Z){super();this.Tya=Z}add(Z){if(this.has(Z))return this;if(this.size>=this.Tya){const ja=this.entries().next().value[0];this.delete(ja)}return super.add(Z)}has(Z){const ja=super.has(Z);return ja?(this.delete(Z),super.add(Z),!0):ja}}Object(r.a)(ta,"LimitedSizeSet",Set,[]);class Ya{constructor(Z,ja,la){this.$=
Z;this.QKd=new cb(la);this.Zfb=new ib(ja,la);k.EwaSettings.isChangeGateEnabled("OfficeVSO:7654591_FormulaByExampleForbiddenFormulas")&&(this.Hwb=new Map,this.jNh=k.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.FormulaByExampleForbiddenFormulasSetSize",5))}Mha(Z){return"Table"===Z.kind?this.Zfb.Mha(Z):this.QKd.Mha(Z)}lka(Z){return"Table"===Z.kind?this.Zfb.lka(Z):this.QKd.lka(Z)}f$e(Z,ja){return this.Zfb.F8h(Z,ja)}wub(Z){"Table"===Z.kind?this.Zfb.wub(Z):this.QKd.wub(Z)}Z8f(Z,ja){Z.state=ja;
Z.bji();k.EwaSettings.isChangeGateEnabled("OfficeVSO:7654591_FormulaByExampleForbiddenFormulas")&&this.Gbh(Z)}Gti(Z){if("Table"===Z.kind){const ja=this.Zfb.kka(Z);if(this.Hwb.has(ja))return this.Hwb.get(ja).has(Z.formula)}return!1}Gbh(Z){switch(Z.state){case "DECLINE":case "UNDO":this.n0e(Z.suggestion);break;case "IGNORE":1<Z.DMb&&this.n0e(Z.suggestion)}}n0e(Z){if("Table"===Z.kind){var ja=this.Zfb.kka(Z);if(!this.Hwb.has(ja)){var la=new ta(this.jNh);this.Hwb.set(ja,la)}la=this.Hwb.get(ja);la.add(Z.formula)}}}
Object(r.a)(Ya,"FormulaByExampleSuggestionCache",null,[]);class Da{constructor(Z){this.abf=!1;this.$=Z}FKg(Z){k.EwaSettings.isChangeGateEnabled("OfficeVSO:7632318_FormulaByExampleSurvey")&&("ACCEPT"===Z?this.$.Yc(-458824895,-1,0,null):"DECLINE"===Z?this.$.Yc(-1726708382,-1,0,null):"IGNORE"===Z&&(this.abf?this.$.Yc(-1227021552,-1,0,null):this.abf=!0))}}Object(r.a)(Da,"FormulaByExampleSurveyManager",null,[]);class ba{constructor(Z,ja,la,ua,eb,Eb){this.zF=this.hF=this.aCa=this.voc=null;this.ONa=this.FB=
!1;this.GQa=null;this.iWd=!1;this.xwb=null;this.Iag=!1;this.Exf=2E3;this.K0e=null;this.mUi=Wb=>{e.ULS.sendTraceTag(520987789,306,50,`FormulaByExampleManager.onCloseCallback: closeReason = ${pa.a[Wb]}`)};this.UNh=(Wb,Ab)=>{e.ULS.sendTraceTag(528758222,306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation received.");if(Wb=Ab.VG){if(Ab=parseInt(Wb.guid,10),!k.EwaSettings.isChangeGateEnabled("OfficeVSO:7417755_FormulaByExampleVerifyDuplicatedAnnotation")||this.Uk.Rkf(Ab)){e.ULS.sendTraceTag(526984792,
306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: received annotation's flowId: ${Ab}.`);this.Uk.vp(Ab,14);var Jb=this.$,Gb=this.J$i(Ab);Wb=Gb.yui?new L(Jb,Wb,Ab,Gb):new fa.a(Jb,Wb,Ab,null,Gb);if("Table"===Wb.kind)if(this.FB&&!this.ONa&&Object(C.f)("ANNOTATIONRECEIVED",Wb.flowId),null!=Wb.errorMessage)e.ULS.sendTraceTag(527005666,306,10,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation arrived with error message: ${Wb.errorMessage}, flowId: ${Wb.flowId}`),this.Uk.vp(Wb.flowId,
15,{reason:"Annotation arrived with error message"});else if(Wb.formula)e.ULS.sendTraceTag(509679808,306,20,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation with a formula suggestion arrived. flowId: ${Wb.flowId}`),this.Uk.vp(Wb.flowId,16,{Woc:Wb.formula}),Wb.table?(this.zF=Wb,(Ab=this.aCa.Mha(Wb))?this.Iag||1!==Wb.invocationMethod?Wb.SJ<Ba.a?e.ULS.sendTraceTag(528758220,306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation does not have enough examples to prompt a suggestion."):
(e.ULS.sendTraceTag(527005665,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation with formula suggestion arrived. trying to suggest/apply it. flowID: ${Wb.flowId}`),0===Wb.invocationMethod?this.TDj(Ab):(Jb=Object(C.c)(Wb.flowId),Jb>this.Exf?(e.ULS.sendTraceTag(509636688,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation arrived after the maximal wait time for suggestions. flowId: ${Wb.flowId}, duration: ${Jb}`),this.Uk.vp(Wb.flowId,6,{reason:"annotation arrived after the maximal wait time for suggestions"})):
(Jb=this.Gag(Ab),Jb.value?this.xjg(Ab,!1,"UponAnnotationReceived"):(e.ULS.sendTraceTag(509636687,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: shouldShowPreview returned false for suggestion with flowId: ${Wb.flowId}, reason: ${Jb.reason}`),this.Uk.vp(Wb.flowId,6,{reason:Jb.reason}))))):e.ULS.sendTraceTag(523850754,306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: session supports suggestions from cache only. returning early after caching suggestion."):e.ULS.sendTraceTag(509678998,
306,15,`FormulaByExampleManager.formulaByExampleAnnotationHandler: failed to cache suggestion for flowId: ${Wb.flowId}.`)):e.ULS.sendTraceTag(509690137,306,10,"FormulaByExampleManager.formulaByExampleAnnotationHandler: session supports suggestions on tables only - but no table was found.");else{e.ULS.sendTraceTag(528758221,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation does not have any formula suggestions. flowId: ${Wb.flowId}`);if(Ab=this.aCa.f$e(Wb.table,Wb.column))this.aCa.wub(Ab.suggestion),
e.ULS.sendTraceTag(512258437,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: existing suggestion cache entry deleted. flowId: ${Wb.flowId}`);this.hF.C7(Wb.originCell,2);this.Uk.vp(Wb.flowId,15)}else S.a.jjc(this.$)||e.ULS.sendTraceTag(509204251,306,10,"FormulaByExampleManager.formulaByExampleAnnotationHandler: range table suggestions should not be created in this session.")}}else e.ULS.sendTraceTag(537161922,306,15,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation is null.")};
this.Pzj=()=>{e.ULS.sendTraceTag(537161889,306,50,"FormulaByExampleManager.SendByExampleFeedback: opening send feedback dialog after click on card.");const Wb={};Wb[H.a.VJ]="FormulaByExampleCard";this.$.Yc(802602464,0,8,Wb)};this.J3i=Wb=>{this.iWd=!0;e.ULS.sendTraceTag(537161888,306,50,`FormulaByExampleManager.OnShowFormula: user clicked ShowFormula button in the card for flow ${Wb}`)};this.odi=Wb=>{e.ULS.sendTraceTag(528758219,306,50,"FormulaByExampleManager.HandleNewBlocksDuringPreview: new block arrived during preview mode.");
var Ab=Wb.dd.block,Jb=this.zF.AO;const Gb=this.zF.range.xe(Ab.Be);Jb=(new I.Range(Jb.top,Jb.left,Jb.bottom,Jb.right,!0,!0)).xe(Ab.Be);Ab=Array.from(this.gridView.fka(Jb,Ab));e.ULS.sendTraceTag(537161886,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: putting skeleton for preview cells in new block ${Wb.dd.hash}.`);this.l2d(Gb,!0);this.ISe(this.zF,Jb,Ab).then(Nb=>{e.ULS.sendTraceTag(537161885,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: putting calculated data into model and demanding re-render for block ${Wb.dd.hash}.`);
this.l2d(Gb,!1);this.QN.Xwf(Wb.dd.block);e.ULS.sendTraceTag(512508567,306,50,`FormulaByExampleManager.handleNewBlocksDuringPreview: new FormulaByExample suggestion block rendered during preview. results: ${JSON.stringify({["flowId"]:this.zF.flowId,["originalFlowId"]:this.zF.hda.flowId,["formulaAnonymized"]:this.zF.anonymizedFormula,["originalFormulaAnonymized"]:this.zF.hda.anonymizedFormula,["annotationRange"]:this.zF.range.toString(),["previewCellsMetadata"]:Nb.Ntc})}`);return!0}).catch(Nb=>{Object(C.h)(this.zF,
`Exception when rendering new block during preview. ${Nb}`);e.ULS.sendTraceTag(537161884,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: caught exception: ${Nb}.`)})};this.WXf=()=>{this.$.userOperationManager.ao(this.EFd);this.EFd=null};this.KPa=(Wb,Ab)=>{0==Ab.Uq&&(this.ONa&&this.GQa.Qka(`UserOperation: ${wa.a(Ab.Gf.operation.operationName)}`),this.$.userOperationManager.ao(this.KPa))};this.EZi=Wb=>{e.ULS.sendTraceTag(528023709,306,20,`FormulaByExampleManager.onImmediateUndo: undo operation queued following a formula by example suggestion application. flowId=${Wb.suggestion.flowId} originalFlowId=${Wb.suggestion.hda.flowId}`);
this.aCa.Z8f(Wb,"UNDO")};this.$=Z;this.Iag=k.EwaSettings.isChangeGateEnabled("OfficeVSO:6169955_ShowFormulaByExampleSuggestionsUponArrivalFromServer");this.Exf=k.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.FormulaByExampleMaximalWaitingTimeForSuggestionsMs",2E3);this.augmentationLoopManager=ja;this.calcManager=la;this.Zg=ua;this.tableIntelligenceManager=Eb;this.xwb=new Map;this.gridView=Object(O.h)(this.$);this.hF=eb;this.Uk=N.a.getInstance(this.$);this.QN=this.gridView.QN;this.aJd=!1;S.a.ijc(this.$)?
this.init():e.ULS.sendTraceTag(537161923,306,10,"FormulaByExampleManager.Ctor: not expected to be constructed when FG is off.")}y5i(Z,ja,la,ua){var eb;const Eb=null===(eb=this.gridView.Jb(Z))||void 0===eb?void 0:eb.cell.sC;this.xwb.set(ja,{range:Z,yui:la,valueType:Eb});la?(this.aJd=!1,(la=this.gridView.tb.uh(Z,!1))?(la=this.aCa.f$e(la,Z.left))?(this.Uk.vp(ja,4),eb=this.Gag(la),eb.value?(la.suggestion.flowId=ja,la.suggestion.originCell=Z,e.ULS.sendTraceTag(529109774,306,50,"FormulaByExampleManager.onTableInput: A cached formula suggestion found for current input."),
this.xjg(la,!0,Object($a.a)(ua))):(this.Uk.vp(ja,6,{reason:eb.reason}),this.v$j(ja,la.suggestion,Z))):this.Uk.vp(ja,5):e.ULS.sendTraceTag(509649310,306,10,`FormulaByExampleManager.onUserInput: getTableContainingRange returned null. flowId: ${ja}, editedCellRange: ${Z}`)):e.ULS.shipAssertTag(524940241,306,!1,"FormulaByExampleManager.onUserInput: expected to be called on tables only.")}v$j(Z,ja,la){k.EwaSettings.isChangeGateEnabled("OfficeVSO:7041480_FormulaByExampleFlowAggregatorFixed")&&this.calcManager.evalFormula(ja.formula,
la,U.d(this.$.na),excelOnlineCalc.calc.evalFormulaFormatOrigin()).then(ua=>{var eb=this.gridView.Jb(la);const Eb=eb.text;eb=eb.cell.Ci;ua=ua.value.value.toString();E.a.equals(Eb,ua,!1)?this.Uk.vp(Z,10):(Object(C.g)(Eb,ua,eb,"evalFormulaToVeriySuggestionWithoutShowingPreview",ja,ja.xkf(la)?"MODIFIEDEXAMPLE":"MODIFIEDRESTOFRANGE"),this.Uk.vp(Z,9))}).catch(ua=>{ua=`Failed to evalFormula, error in calc API: ${ua.toString()}`;e.ULS.sendTraceTag(512341207,306,50,`FormulaByExampleMangaer.verifySuggestionOnEditedCell: ${ua}`);
this.Uk.vp(Z,9,{reason:ua})})}dispose(){this.$.userOperationManager.ao(this.KPa);this.WXf();this.augmentationLoopManager.unregister("FormulaByExample")}init(){const {FormulaByExampleAutoSuggestActor:Z}=a(1355);this.augmentationLoopManager.register(this.augmentationLoopManager.O4a().xeb("FormulaByExample").ueb(this.mUi).activateAnnotation({annotationType:Y.a.getTypeName(),Au:!1,JK:this.UNh}).build());this.FB=Object(C.a)(this.$);new Z(this.$,this.calcManager,this.tableIntelligenceManager,this.FB);this.aCa=
new Ya(this.$,this.calcManager,this.hF);this.voc=new ea(this.$,this.calcManager,this.Zg,this.FB);this.K0e=new Da(this.$);e.ULS.sendTraceTag(528758223,306,50,"FormulaByExampleManager.init: init complete.")}J$i(Z){if(!this.xwb.has(Z))return null;const ja=this.xwb.get(Z);this.xwb.delete(Z);return ja}TDj(Z){const ja=Z.suggestion;this.voc.HSe(ja,ja.range,null).then(la=>{this.n_c(Z,1===la.status?la.ubd:null);return null}).catch(()=>{e.ULS.sendTraceTag(537161921,306,50,"FormulaByExampleManager.setFormulaOnRangeExplicit: client estimation failed for explicit by example flow.");
this.n_c(Z,null)})}xjg(Z,ja,la){e.ULS.sendTraceTag(527713160,306,20,`FormulaByExampleManager.tryDisplayFormulaSuggestionPreview: starting flow to show a formula suggestion. isFromCache: ${ja}`);const ua=Z.suggestion;this.FB&&!this.ONa&&Object(C.f)("CALCULATIONSTART",ua.flowId,ja);var eb=k.EwaSettings.isChangeGateEnabled("OfficeVSO:7189977_SendCloneUpdatesOnPreview")?this.j5e(ua.AO):null;eb=this.ISe(ua,this.gridView.pi,eb,ja);const Eb=eb.then(()=>this.QN.Foa(ua.range,this.odi).then(Wb=>{this.ONa=!0;
this.GQa=Wb;this.$.userOperationManager.jr(this.KPa);this.hF.show(ua.formula,ua.range.toString(),()=>Wb.q_b("CardUI"),()=>Wb.i8b("CardUI"),this.Pzj,()=>this.J3i(ua.flowId),ua.originCell);this.hF.C7(ua.originCell,0);this.FB&&da.a(()=>{Object(C.f)("PREVIEWRENDERED",ua.flowId,ja);const Ab=Object(C.e)(ja,ua.flowId);e.ULS.sendTraceTag(529109772,306,50,`FormulaByExampleManager.TryDisplayFormulaSuggestionPreview: durations for preview shown flow: ${JSON.stringify(Ab)}`)},this.$.ka);return Wb.I1f}));Promise.all([eb,
Eb]).then(Wb=>{this.aJd=!0;this.Ddi(Wb[0],Wb[1],Z,ja,la)}).catch(Wb=>{Object(C.h)(ua,`Failed to show formula preview due to a promise (model update or preview render) rejection. rejection reason: ${Wb}`);e.ULS.sendTraceTag(537161920,306,15,`FormulaByExampleManager.TryDisplayFormulaSuggestionPreview: failed to show formula preview due to promise rejection. rejection reason: ${Wb}`);this.hF.C7(ua.originCell,5,Wb);Z.state=bb.ignore})}ISe(Z,ja,la=null,ua){return this.voc.UDj(Z,ja,la,this.ONa,ua).then(eb=>
{e.ULS.sendTraceTag(537161887,306,50,`FormulaByExampleManager.EvaluateFormulaAndUpdateModel: model update completed. result: ${eb.status}.`);switch(eb.status){case 3:case 1:return 3===eb.status&&Object(C.h)(Z,"Preview shown, but only partially. some cells failed to evaluate."),Promise.resolve(eb);case 2:return Promise.reject("Calc estimation or model update failed");default:return Promise.reject("Calc estimation failed")}})}Ddi(Z,ja,la,ua,eb){const Eb=this.iWd;this.ptj();const Wb=la.suggestion;this.FB&&
Object(C.f)("USERINPUTARRIVED",Wb.flowId,ua);this.l2d(Wb.range,!1);this.hF.hide();da.a(()=>{this.FB&&Object(C.f)("PREVIEWREMOVEDWITHCSE",Wb.flowId,ua);const Ab={["flowId"]:Wb.flowId,["originalFlowId"]:Wb.hda.flowId,["caller"]:ja.yBe,["displayTrigger"]:eb,["formulaAnonymized"]:Wb.anonymizedFormula,["originalFormulaAnonymized"]:Wb.hda.anonymizedFormula,["suggestionOutcome"]:ja.lJb,["annotationRange"]:Wb.range.toString(),["isFullyInViewport"]:this.gridView.gN(Wb.range),["isCachedSuggestion"]:ua,["showFormulaClicked"]:Eb,
["exampleCount"]:Wb.SJ,["originalExampleCount"]:Wb.hda.SJ,["seenCount"]:la.DMb,["previewCellsMetadata"]:Z.Ntc,["previewShownDurations"]:this.FB?Object(C.e)(ua,Wb.flowId):"none",["previewRemovedDurations"]:this.FB?Object(C.d)(ua,Wb.flowId):"none"};e.ULS.sendTraceTag(388780100,306,50,`FormulaByExampleManager.handlePreviewResult: FormulaByExample flow results: ${JSON.stringify(Ab)}`);Object(C.b)(Wb.flowId)},this.$.ka);e.ULS.sendTraceTag(523842074,306,50,`FormulaByExampleManager.handlePreviewResult: User ${ja.lJb} the formula via ${ja.yBe}`);
this.aCa.Z8f(la,ja.lJb);"ACCEPT"===ja.lJb&&this.n_c(la,Z.ubd);this.K0e.FKg(ja.lJb);this.$.userOperationManager.ao(this.KPa)}ptj(){this.ONa=!1;this.GQa=null;this.iWd=!1}n_c(Z,ja){let la=Z.suggestion;const ua=Object(z.a)(new R.a,{Text:la.formula});this.gridView.setCell(ua,la.originCell,1,127,null,0,la.range,2);this.voc.HVg(ja,la.formula);e.ULS.sendTraceTag(537161883,306,50,`FormulaByExampleManager.applyFormulaSuggestionOnRange: applied formula on table, range: ${la.range}`);this.EFd=(eb,Eb)=>{0==Eb.Uq&&
(170==Eb.Gf.operation.operationName&&this.EZi(Z),this.WXf())};this.$.userOperationManager.jr(this.EFd)}Gag(Z){const ja=Z.suggestion,la=this.hri(ja.flowId);return la.value?Z.state===bb.decline?(this.hF.C7(Z.suggestion.originCell,6,Ea.a.Xtg),e.ULS.sendTraceTag(528758217,306,50,`FormulaByExampleManager.shouldShowPreview: user declined this suggestion before, not showing again. flowId: ${ja.flowId}`),{value:!1,reason:"User declined this suggestion before."}):ja.SJ<Ba.a?(this.hF.C7(Z.suggestion.originCell,
6,Ea.a.ptg),e.ULS.sendTraceTag(528758215,306,50,`FormulaByExampleManager.shouldShowPreview: cached suggestion does not have enough examples. not showing preview. flowId: ${ja.flowId}`),{value:!1,reason:"Cached suggestion does not have enough examples."}):Z.state===bb.ignore&&2<=Z.DMb?(this.hF.C7(Z.suggestion.originCell,6,Ea.a.Wtg),e.ULS.sendTraceTag(528758216,306,50,`FormulaByExampleManager.shouldShowPreview: user saw suggestion at least twice and ignored last time. not showing again. flowId: ${ja.flowId}`),
{value:!1,reason:"User saw suggestion at least twice and ignored last time"}):k.EwaSettings.isChangeGateEnabled("OfficeVSO:7654591_FormulaByExampleForbiddenFormulas")&&this.aCa.Gti(ja)?(e.ULS.sendTraceTag(509195993,306,50,`FormulaByExampleManager.shouldShowPreview: suggestion is forbidden. not showing preview. flowId: ${ja.flowId}`),{value:!1,reason:"Cached suggestion is forbidden as it wasn't wanted before."}):k.EwaSettings.isChangeGateEnabled("OfficeVSO:7300192_FBETextCellsUnsupported")&&this.j5e(ja.range).some(ua=>
this.calcManager.Tzi(ua.cell.Ci))?{value:!1,reason:"At least 1 cell in the loaded suggestion range is formatted as Text"}:k.EwaSettings.isChangeGateEnabled("OfficeVSO:7464540_FBENoneValueTypesUnsupported")&&0===ja.UMe?{value:!1,reason:"suggestion's default value type cannot be none."}:{value:!0}:(this.hF.C7(Z.suggestion.originCell,6,Ea.a.Zrg),{value:!1,reason:la.reason})}l2d(Z,ja){for(let ua=Z.top;ua<=Z.bottom;ua++)for(let eb=Z.left;eb<=Z.right;eb++){var la=I.Range.Hc(ua,eb);if(la=this.gridView.Jb(la))la.cell.pcg=
ja&&!la.cell.Mbb}}hri(Z){return this.aJd?(e.ULS.sendTraceTag(528758218,306,50,`FormulaByExampleManager.shouldShowPreview: can't show preview again as preview already was shown for the current edit. flowId: ${Z}`),{value:!1,reason:"Preview already shown for the latest edit."}):this.ONa?(e.ULS.sendTraceTag(527005664,306,50,`FormulaByExampleManager.shouldShowPreview: can't show preview for this suggestion as preview is already showing. flowId: ${Z}`),{value:!1,reason:"Preview is already showing."}):
this.gridView.eb?(e.ULS.sendTraceTag(524813027,306,50,`FormulaByExampleManager.shouldShowPreview: can't show preview for this suggestion as user is editing. flowId: ${Z}`),{value:!1,reason:"User is editing."}):{value:!0}}j5e(Z){let ja=[];const la=this.gridView.Ca.gka(Z,this.gridView.$.activeItemName);for(const ua of la)ja.push(...this.gridView.fka(Z.xe(ua.Be),ua));return ja}}Object(r.a)(ba,"FormulaByExampleManager",null,[322,3]);class ya extends w.a{constructor(Z){super();this.$=Z;this.Gb()}create(){e.ULS.sendTraceTag(528758214,
0,50,"FormulaByExampleManagerFactory.Create: starting service creation flow.");const Z=d.GetServiceTaskFactory.Pa(this.$.da,328,327,1);let ja;ja=k.EwaSettings.OH()?Object(u.c)(y.a.resolve(t.f,{Wb:1})):d.GetServiceTaskFactory.Pa(this.$.da,266,265,1);let la=A.Task.Ta(null);k.EwaSettings.isChangeGateEnabled("OfficeVSO:6327953_FormatOutputResultsOfFBE_V2")&&(la=k.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.FormatCellsActionNewService",!1)?Object(u.c)(y.a.resolve(t.r,{Wb:1})):d.GetServiceTaskFactory.create(this.$.da,
18,this.$.ka,1));const ua=S.a.jjc?d.GetServiceTaskFactory.Pa(this.$.da,20,404,1):A.Task.Ta(null),eb=[Z,ja,la,ua];m.init(this.$);h.TaskExtensions.za(h.TaskExtensions.Md(eb,this.ka),()=>{e.ULS.sendTraceTag(528758213,0,50,"FormulaByExampleManagerFactory.Create: augmentationLoopManager and calcManager creation tasks resolved.");const Eb=new ba(this.$,Z.result,ja.result,la.result,m.instance(),ua.result);this.qb(this.$.da.Ba(453)||this.$.da.Ha(453,Eb));e.ULS.sendTraceTag(537161882,0,50,"FormulaByExampleManagerFactory.Create: FormulaByExampleManager initialized successfully")},
this.ka)}static la(Z){Z.da.Ha(454,new ya(Z))}}Object(r.a)(ya,"FormulaByExampleManagerFactory",w.a,[]);a.d(B,"a",function(){return V});const V=()=>{b.a.Fa(Z=>{ya.la(Z);v.la(Z)})}},1315:function(r,B,a){r=a(0);var c=a(7),b=a(15),e=a(24),f=a(33),d=a(182),h=a(196),l=a(21),k=a(840),w=a(718);class n extends k.a{constructor(){super();this.formulasCount=this.columnNames=this.additionalInputs=this.examples=null;this.invocationMethod=this.stateID=0;this.guid=this.supportedFunctions=null;this.H_=Object.assign(new w.a,
{T_:n.getTypeName(),B_:n.Pd()})}static getTypeName(){return"AugLoop_FormulaByExample_FormulaByExampleSignal"}static Pd(){return["AugLoop_Signals_Signal"]}}Object(r.a)(n,"FormulaByExampleSignal",k.a,[]);var x=a(1324),m=a(58),u=a(839),t=a(1),y=a(294),v=a(874),A=a(44),z=a(104),C=a(894),H=a(1005);a.d(B,"b",function(){return S});a.d(B,"a",function(){return P});const I={TEXTSPLIT:!1,TEXTSLICE:!1,FINDN:!1,TEXTAFTER:!1,TEXTBEFORE:!1},S={fad:"editRange",Hgb:"triggerCommand",h0d:"triggerKind",I_e:"flowId",
Dlf:"isInExplicitTable",igg:"tableInnerRange",Pvi:"isNewRowPrediction"};class P{constructor(D,G,E,O,N){this.FB=!1;this.$=D;this.gridView=Object(l.h)(D);this.augmentationLoopManager=G;this.calcManager=E;this.formulaByExampleManager=O;this.hF=N;this.Uk=v.a.getInstance(this.$);this.FB=Object(u.a)(this.$);this.oMi=t.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.FormulaByExampleMaximalNumberOfAdditionalInputRows",30);b.ULS.sendTraceTag(528758226,306,50,"FormulaByExampleCommandHandler.ctor: FBE command handler created")}Mc(){return!1}executeCommand(D,
G,E){D=!1;G=G.command;switch(G){case 1928326585:D=E&&E[S.h0d]?E[S.h0d]:0;const O=E[S.I_e];if(0===D)return b.ULS.sendTraceTag(524940245,306,15,"FormulaByExampleManager.executeCommand: triggerFormulaByExample command called for execution with NoTrigger value."),this.Uk.vp(O,1),m.Task.Ta(!0);const N=!E||!E[S.fad],J=this.XXh(E,N),W=E[S.igg],ea=!E||E[S.Dlf];E=!E||E[S.Hgb];!N&&2===D&&ea&&this.formulaByExampleManager.y5i(J,O,ea,E);D=this.triggerFormulaByExample(J,W,N,O,ea)}return D?m.Task.Ta(!0):Object(h.a)(G)}Ac(D,
G){switch(G.command){case 1928326585:return f.a.ijc(this.$);default:return!1}}Rc(){return!1}XXh(D,G){b.ULS.sendTraceTag(537161928,306,50,`FormulaByExampleCommandHandler.getEditedRange: flow triggered from: ${G?"Ribbon":"AutoDetect"}`);return G?this.gridView.ha.ra.activeCell:D[S.fad]}triggerFormulaByExample(D,G,E,O,N){if(!this.augmentationLoopManager)return b.ULS.sendTraceTag(537161927,306,10,"FormulaByExampleCommandHandler.TriggerFormulaByExample: augmentationLoopManager instance is null"),this.Uk.vp(O,
13,{reason:"AugmentationLoopManager instance is null"}),!1;G=this.GZh(D,G,E,O,N);if(!G)return this.Uk.vp(O,13,{reason:"Signal is null"}),!0;b.ULS.sendTraceTag(537161926,306,50,`FormulaByExampleCommandHandler.TriggerFormulaByExample: calling SubmitOperationSignal for flowId: ${O}.`);this.augmentationLoopManager.mPb(G);this.Uk.vp(O,12);this.hF.C7(D,1);this.FB&&Object(u.f)("SIGNALSENT",O);return!0}GZh(D,G,E,O,N){const J=this.YTh(G,D,O);if(!J)return null;let W;if(N){D=this.gridView.tb.uh(D,!1);if(!D)return b.ULS.sendTraceTag(537161925,
306,15,"FormulaByExampleCommandHandler.TriggerFormulaByExample: table returned null for given edit range."),this.Uk.vp(O,13,{reason:"Table returned null for given edit range"}),null;W=this.qVh(D)}else f.a.jjc(this.$)&&(W=this.pVh(G,D));if(!W)return null;E=Object(c.a)(new n,{formulasCount:1,examples:J.examples,additionalInputs:J.additionalInputs,columnNames:W,stateID:this.$.ea.dEb,invocationMethod:E?0:1,guid:O.toString(),supportedFunctions:I});b.ULS.sendTraceTag(528758225,306,50,"FormulaByExampleCommandHandler.getFormulaByExampleSignalFromTable: signal generated.");
return E}YTh(D,G,E){return this.ZTh(D,G,E)}qVh(D){const G=[],E=D.name;var O=Object(d.a)(D);D=this.calcManager.Gec(D);if(O&&D){O=O.left;for(let N of D)G.push({column:O,name:E+"[@["+N+"]]"}),O++;return G}b.ULS.sendTraceTag(524940244,306,15,`FormulaByExampleCommandHandler.getColumnNamesMapFromTable: failed to generate columnNames. is tableRange null: ${!O}, is colNamesCurrentTable null: ${!D}`);return null}pVh(D,G){const E=[];G=new e.Range(G.top,D.left,G.top,D.right,!0,!0);D=this.gridView.Qj("FormulaByExample.getColumnNamesMapFromInputRange",
G);for(G=G.left;D.$$mn();){const O={column:G++,name:`${e.Range.sM(D.$$cu().range.left)+H.b}`};E.push(O)}return E}ZTh(D,G,E){G=G.left;let O=new Set;t.EwaSettings.isChangeGateEnabled("OfficeVSO:7126337_FBECellCycleFix")&&(O=this.zZh(D,G,E));return this.olh(D,G,O)}zZh(D,G,E){const O=new Set,N=this.gridView.Qj("FormulaByExample.getForbiddenColumnsFromRange",D);try{for(;N.$$mn();){const J=N.$$cu(),W=J.range,ea=W.left;if(ea!==G&&!O.has(ea)){const R=new e.Range(W.top,G,W.top,G,!1,!1);this.fsi(J,R)&&(O.add(ea),
this.Uk.Qpc(E,ea-(this.$.na.displayRtl?D.right:D.left)))}}}finally{N&&N.dispose()}return O}olh(D,G,E){const O=[],N=[],J=D.right,W=new Set;let ea=[],R=!1,Y=null;D=this.gridView.Qj("FormulaByExample.createValidExamplesFromRange",D);try{for(;D.$$mn();){const U=D.$$cu(),da=U.range.left,T=da===G;T&&U.text?Y=this.$Ie(U):T||E.has(da)||(U.text&&(R=!0),ea.push(this.$Ie(U)));da===J&&(R&&(Y?(O.push({output:Y,inputs:ea}),W.add(Y.rawValueJson)):N.length<this.oMi&&N.push({output:null,inputs:ea})),ea=[],R=!1,Y=
null)}}finally{D&&D.dispose()}return W.size<C.a?(b.ULS.sendTraceTag(509683013,306,50,"FormulaByExampleCommandHandler.createValidExamplesFromRange: column does not have enough distinct examples with inputs."),null):{examples:O,additionalInputs:N}}fsi(D,G){const E=D.QO,O=D.range,N=this.$.workbookContext.WorkbookFileName,J=this.$.na;if(!J)return b.ULS.sendTraceTag(509743199,306,50,"FormulaByExampleCommandHandler.isDependingOn: this.ewaControl.activeItem returned null. Expected to be an object of type Sheet."),
!1;if(!(t.EwaSettings.isChangeGateEnabled("OfficeVSO:7251463_FBEFixJsCrashOnNullActiveSheet")||J instanceof z.a))return b.ULS.sendTraceTag(509743198,306,50,"FormulaByExampleCommandHandler.isDependingOn: this.ewaControl.activeItem returned object of type other then Sheet. Expected to be an object of type Sheet."),!1;if(!this.calcManager.clf(D.cell.Ci,E))return!1;if(D=this.calcManager.extractReferences(E,J.name,N,!0,O))for(const W of D.Items)if(Object(A.E)(W.Range).equals(G))return!0;return!1}$Ie(D){let G;
if(1===D.Nr.type){G=parseFloat(D.Nr.value);var E=this.calcManager.t5a(D.cell.Ci);Object(y.c)(E)?E=E.value.isDate?4:E.value.isTime?5:1:(b.ULS.sendTraceTag(522840207,0,10,`FormulaByExampleCommandHandler.createAugLoopCell: CalcManager's getNumberFormat method failed on the given cell, falling back to number format. failureReason: ${E.reason}`),E=1)}else G=D.text,E=0;return Object.assign(new x.a,{row:D.range.top,column:D.range.left,displayText:D.text,rawValueJson:JSON.stringify(G),numberFormatCategory:E.toString()})}}
Object(r.a)(P,"FormulaByExampleCommandHandler",null,[222])},1355:function(r,B,a){a.r(B);a.d(B,"FormulaByExampleAutoSuggestActor",function(){return t});r=a(0);var c=a(15),b=a(24),e=a(182),f=a(96),d=a(21),h=a(839),l=a(1315),k=a(33),w=a(894),n=a(874),x=a(1),m=a(350),u=a(71);class t{constructor(y,v,A,z){this.z_c=this.FB=!1;this.zPa=(C,H)=>{C=H.Sk;if(H.E1a){var {AO:I,O7a:S,xla:P}=this.i$e(C);I&&C.vd(I)?(S&&this.vgf(C,324156914),this.Vqi(C)?this.AFf(C,C,I,324156914,S,P):this.VAa()):this.VAa()}else this.VAa()};
this.uFd=(C,H)=>{C=H.destinationRange;if(1804571062===H.command||C.left!==C.right)this.VAa();else{var I=new b.Range(C.top,C.right,C.top,C.right,!1,!1),{AO:S,O7a:P,xla:D}=this.i$e(I);S?(P&&this.vgf(I,H.command),this.AFf(I,C,S,H.command,P,D)):this.VAa()}};this.o4i=(C,H)=>{C=this.pya.f6g;H=H.Sk.toString();C.has(H)&&(C.delete(H),0===C.size&&this.FOe())};this.$=y;this.gridView=d.h(y);this.calcManager=v;this.FB=z;this.VAa();this.gridView.Xb.rm(this.zPa);this.calcManager.EPg(this.o4i);x.EwaSettings.isChangeGateEnabled("OfficeVSO:7395435_FormulaByExampleTriggerOnCSEPaste")&&
this.gridView.ite(this.uFd);this.Uk=n.a.getInstance(y);if(this.z_c=k.a.jjc(this.$))this.OCc=A.pwa(),this.awj=x.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.FormulaByExampleRowsBelowRangeTableToQuery",1)}i$e(y){const v=this.gridView.tb.uh(y,!1);if(v)return{AO:e.a(v),O7a:!0,xla:!1};if(this.z_c){const {bUf:A,xla:z}=this.d5h(y);if(A)return{AO:A,O7a:!1,xla:z}}return{AO:null,O7a:!1,xla:!1}}d5h(y){const v=new b.Range(y.top-this.awj,y.left,y.bottom,y.right,!0,!0),A=this.OCc.F5a(new m.a(v,u.d(this.$.na)),
6);if(!A)return null;for(const z of A)for(const C of z.table.interpretations)if(2===C.orientation&&.5<C.confidence)return{bUf:new b.Range(C.PD.top+C.headerRowCount,C.PD.left+C.headerColumnCount,Math.max(C.PD.bottom,v.bottom),C.PD.right,!0,!0),xla:!C.PD.vd(y)};return{bUf:null,xla:!1}}AFf(y,v,A,z,C,H){this.a8f(y,v,A,z,C,H);-185374993===z&&this.FOe()}vgf(y,v){const A=this.gridView.tb.uh(y,!1);this.Uk.FEf(v,A.name,y.left-(A.displayRtl?A.usedRange.right:A.usedRange.left),y.top-A.usedRange.top)}Vqi(y){var v=
this.gridView.Jb(y);if(!v)return c.ULS.sendTraceTag(524120778,306,15,`FormulaByExampleAutoSuggestActor.isCellValidForTriggeringFormulaByExample: formattedCell is null. investigation hints: is cell null = ${!y}`),this.Uk.vp(n.b,1,{reason:"Didn't trigger since the formattedCell is null."}),!1;y=this.calcManager.clf(v.cell.Ci,v.QO);(v=null!==y&&!y)||this.Uk.vp(n.b,1,{reason:`Didn't trigger since edited cell content is a formula or isFormulaCell returned null. isFormulaText is null:${null==y}`});return v}FOe(){const y=
this.Gyj(this.pya.originCell,this.pya.AO);if(0===y)this.VAa(),this.Uk.vp(n.b,1);else{var v=this.Uk.$6e();this.Uk.vp(v,3);c.ULS.sendTraceTag(537161929,306,50,`FormulaByExampleAutoSuggestActor.tryTriggeringFormulaByExample: triggering FormulaByExample for cell edit. Trigger kind: ${y}, FlowId: ${v}`);this.FB&&Object(h.f)("EDITCOMMIT",v);var A=new f.a(1928326585,1,2,6,null);this.$.Ia.Hb(A,{[l.b.fad]:this.pya.originCell,[l.b.Hgb]:this.pya.Hgb,[l.b.h0d]:y,[l.b.I_e]:v,[l.b.igg]:this.pya.AO,[l.b.Dlf]:this.pya.O7a,
[l.b.Pvi]:this.pya.xla});this.VAa()}}Gyj(y,v){y=y.left;v=new b.Range(v.top,y,v.bottom,y,!0,!0);return this.Fyj(v)}Fyj(y){var v;let A=new Set,z=0;y=this.gridView.Qj("FormulaByExampleAutoSuggestActor:Table",y);try{for(;y.$$mn();){const C=y.$$cu();if(null===(v=C.Nr)||void 0===v?0:v.value)if(A.add(C.Nr.value),z++,A.size>=w.a)return 2}}finally{y&&y.dispose()}z>=w.a?(c.ULS.sendTraceTag(523368219,306,50,"FormulaByExampleAutoSuggestActor.searchForSufficientExamplesInOutputColumn: Table has sufficient example amount - but not enough distinct examples."),
this.Uk.vp(n.b,1,{reason:"Didn't trigger since there aren't enough distinct outputs"})):this.Uk.vp(n.b,1,{reason:"Didn't trigger since there aren't enough examples"});return 0}VAa(){this.a8f(null,null,null,null,null,null)}a8f(y,v,A,z,C,H){this.pya={originCell:y,f6g:new Set(null===v||void 0===v?void 0:v.sxe(v.hw).map(I=>I.toString())),Hgb:z,AO:A,O7a:C,xla:H}}}Object(r.a)(t,"FormulaByExampleAutoSuggestActor",null,[])},1473:function(r,B,a){function c(ma){for(const Ga of ma.values())for(const vb of Ga.annotations)if(t.EwaSettings.isChangeGateEnabled("OfficeVSO:7526430_SupportInternalAnnotations")){if(!vb.isInternal&&
!vb.Au)return!0}else if(!vb.Au)return!0;return!1}function b(ma){return void 0===ma?"undefined":`${null===ma||void 0===ma?void 0:ma.Xluid}/${null===ma||void 0===ma?void 0:ma.Xrevid}@${null===ma||void 0===ma?void 0:ma.DocId}`}a.r(B);r=a(0);var e=a(7),f=a(15),d=a(102);B=a(228);class h{}Object(r.a)(h,"WorkbookCoauthVersion",null,[]);var l=a(39);class k{constructor(){this.stateId=0;this.O2d=null}}Object(r.a)(k,"StateIdChangedInfo",null,[]);var w=a(63);const n=(ma,Ga,vb,Ka,Pa,fb,Wa=null)=>{Wa=ma.Oa(1,Wa);
Wa.isObserverRequired=Ga;return w.g(ma,"ObserverRequiredNotification",Wa,vb,Ka,Pa,fb,0)};class x extends Sys.EventArgs{constructor(ma,Ga,vb,Ka){super();this.VG=ma;this.parentPath=vb;this.operationType=Ka}}Object(r.a)(x,"AnnotationReceivedEventArgs",Sys.EventArgs,[]);var m=a(28),u=a(125),t=a(1);class y{constructor(){this.stateUpdateHandler=this.handler=this.config=this.annotationType=null}}Object(r.a)(y,"ActivateAnnotationParameters",null,[]);class v{constructor(){this.supportCustomMessages=this.accessTokenTTL=
this.accessToken=this.collabStateId=this.userListVersion=this.configurations=this.permissionFlags=this.serverEventVersion=this.metadataVersion=this.ecsOperationUrl=this.ecsRestUrl=this.ecsSessionId=this.wacCluster=null}}Object(r.a)(v,"ExcelServerParameters",null,[]);class A{constructor(){this.excelServerParameters=null}}Object(r.a)(A,"ForceReconnectParameters",null,[]);class z{constructor(){this.workflow=null}}Object(r.a)(z,"RegisterLocalWorkflowParameters",null,[]);class C{constructor(){this.handler=
null}}Object(r.a)(C,"SetAnnotationResultCallbackParameters",null,[]);class H{constructor(){this.message=null}}Object(r.a)(H,"SubmitCustomMessageParameters",null,[]);class I{constructor(){this.operation=null}}Object(r.a)(I,"SubmitOperationParameters",null,[]);var S=a(741),P=a(999),D=a(768),G=a(718);class E extends D.a{constructor(){super();this.H_=Object.assign(new G.a,{T_:E.getTypeName(),B_:E.Pd()})}static getTypeName(){return"AugLoop_Core_DeleteOperation"}static Pd(){return["AugLoop_Core_Operation"]}}
Object(r.a)(E,"DeleteOperation",D.a,[]);class O extends D.a{constructor(){super();this.isFocused=!1;this.H_=Object.assign(new G.a,{T_:O.getTypeName(),B_:O.Pd()})}static getTypeName(){return"AugLoop_Core_FocusOperation"}static Pd(){return["AugLoop_Core_Operation"]}}Object(r.a)(O,"FocusOperation",D.a,[]);var N=a(892),J=a(1E3);class W extends J.a{constructor(){super();this.prevParentPath=null;this.H_=Object.assign(new G.a,{T_:W.getTypeName(),B_:W.Pd()})}static getTypeName(){return"AugLoop_Core_MoveOperation"}static Pd(){return["AugLoop_Core_OperationWithSiblingContext",
"AugLoop_Core_Operation"]}}Object(r.a)(W,"MoveOperation",J.a,[]);var ea=a(998);class R extends D.a{constructor(){super();this.M_=null;this.H_=Object.assign(new G.a,{T_:R.getTypeName(),B_:R.Pd()})}static getTypeName(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}static Pd(){return["AugLoop_Core_Operation"]}}Object(r.a)(R,"UpdateAnnotationMetaDataOperation",D.a,[]);var Y=a(1001);class U extends D.a{constructor(){super();this.isVisible=!1;this.H_=Object.assign(new G.a,{T_:U.getTypeName(),B_:U.Pd()})}static getTypeName(){return"AugLoop_Core_VisibilityOperation"}static Pd(){return["AugLoop_Core_Operation"]}}
Object(r.a)(U,"VisibilityOperation",D.a,[]);var da=a(735);class T extends da.a{constructor(){super();this.bridgeId=this.cv=this.messageId=null;this.H_=Object.assign(new G.a,{T_:T.getTypeName(),B_:T.Pd()})}static getTypeName(){return"AugLoop_Session_Protocol_Message"}static Pd(){return[]}}Object(r.a)(T,"Message",da.a,[]);class ka extends T{constructor(){super();this.activeWorksheetId=null;this.H_=Object.assign(new G.a,{T_:ka.getTypeName(),B_:ka.Pd()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelKeepAlive"}static Pd(){return["AugLoop_Session_Protocol_Message"]}}
Object(r.a)(ka,"ExcelKeepAlive",T,[]);class L extends S.a{constructor(){super();this.isObserverRequired=this.isSeedingRequired=!1;this.H_=Object.assign(new G.a,{T_:L.getTypeName(),B_:L.Pd()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation"}static Pd(){return["AugLoop_Core_Annotation"]}}Object(r.a)(L,"ObserverStatusAnnotation",S.a,[]);class fa extends T{constructor(){super();this.parentPath=this.opType=this.seq=this.item=null;this.H_=Object.assign(new G.a,{T_:fa.getTypeName(),
B_:fa.Pd()})}static getTypeName(){return"AugLoop_Session_Protocol_MicroSyncMessage"}static Pd(){return["AugLoop_Session_Protocol_Message"]}}Object(r.a)(fa,"MicroSyncMessage",T,[]);class wa extends da.a{constructor(){super();this.id=null;this.sizeBytes=0;this.dataPointer=this.data=null;this.H_=Object.assign(new G.a,{T_:wa.getTypeName(),B_:wa.Pd()})}static getTypeName(){return"AugLoop_Core_Blob"}static Pd(){return[]}}Object(r.a)(wa,"Blob",da.a,[]);class oa extends wa{constructor(){super();this.format=
0;this.otherFormat=null;this.size=0;this.isOriginalSize=null;this.H_=Object.assign(new G.a,{T_:oa.getTypeName(),B_:oa.Pd()})}static getTypeName(){return"AugLoop_Image_ImageContent"}static Pd(){return["AugLoop_Core_Blob"]}}Object(r.a)(oa,"ImageContent",wa,[]);class xa extends da.a{constructor(){super();this.heightPx=this.widthPx=0;this.H_=Object.assign(new G.a,{T_:xa.getTypeName(),B_:xa.Pd()})}static getTypeName(){return"AugLoop_Image_ImageTileMetadata"}static Pd(){return[]}}Object(r.a)(xa,"ImageTileMetadata",
da.a,[]);class bb extends xa{constructor(){super();this.contents=null;this.H_=Object.assign(new G.a,{T_:bb.getTypeName(),B_:bb.Pd()})}static getTypeName(){return"AugLoop_Image_ImageTile"}static Pd(){return["AugLoop_Image_ImageTileMetadata"]}}Object(r.a)(bb,"ImageTile",xa,[]);var Za=a(103),La;(function(ma){ma[ma.unknown=0]="unknown";ma[ma.fatal=1]="fatal";ma[ma.tokenExpired=2]="tokenExpired";ma[ma.modelWorkflowNotSupported=3]="modelWorkflowNotSupported"})(La||(La={}));Object(r.b)("ExcelSessionErrorType",
La);class va{constructor(){this.annotations=[]}ueb(ma){this.cH=ma;return this}activateAnnotation(ma){if(this.annotations.includes(ma))throw ma=`Annotation from type ${ma.annotationType} was already activated`,f.ULS.sendTraceTag(521216417,0,10,`AugmentationLoopFeatureRegistrationInfoBuilder.activateAnnotation: ${ma}`),Error(ma);this.annotations.push(ma);return this}xeb(ma){this.featureName=ma;return this}build(){if(void 0===this.cH)throw f.ULS.sendTraceTag(521216416,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Close callback is not set"),
Error("Close callback is not set");if(!t.EwaSettings.isChangeGateEnabled("OfficeVSO:7386847_AddingActivateAnnotationToRegisteredFeatures")&&0===this.annotations.length)throw f.ULS.sendTraceTag(521216415,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: No annotations were activated"),Error("No annotations were activated");if(!this.featureName)throw f.ULS.sendTraceTag(521216414,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Feature Name is not set"),Error("Feature Name is not set");
return{featureName:this.featureName,cH:this.cH,annotations:this.annotations}}}Object(r.a)(va,"AugmentationLoopFeatureRegistrationInfoBuilder",null,[610]);var Ba=a(71),Ea;(function(ma){ma[ma.FullyActive=0]="FullyActive";ma[ma.ClosedAndWaitingOnlyForNonModelRequiredActivation=1]="ClosedAndWaitingOnlyForNonModelRequiredActivation";ma[ma.ActiveForNonModelRequired=2]="ActiveForNonModelRequired";ma[ma.Closed=3]="Closed"})(Ea||(Ea={}));Object(r.b)("AugmentationLoopServerStatus",Ea);class pa extends l.a{constructor(ma,
Ga,vb,Ka=null){var Pa,fb;super();this.$ma=null;this.isObserverRequired=!1;this.He=null;this.EP=Ea.FullyActive;this.vmf=!0;this.wna=new Map;this.pZa=[];this.epe=new Set;this.Ipc=[];this.Hpc=new Map;this.q_a=[];this.pHh=new Map([[0,"Unknown"],[1,"Permanent"],[2,"Permanent"],[3,"ModelWorkflowNotSupported"]]);this.s_a=!1;this.SGc=new h;this.hxa=t.EwaSettings.isChangeGateEnabled("OfficeVSO:7386847_AddingActivateAnnotationToRegisteredFeatures");this.Xhc=t.EwaSettings.isChangeGateEnabled("OfficeVSO:7403069_ALSendActiveWorksheetId");
this.Sof=t.EwaSettings.isChangeGateEnabled("OfficeVSO:7526430_SupportInternalAnnotations");this.qqd=t.EwaSettings.isChangeGateEnabled("OfficeVSO:7550262_AddALResultToALAPI");this.Wc=(Wa,Ma)=>{Ma.GH&&this.$.ea.sessionId&&(f.ULS.sendTraceTag(537170394,0,50,`AugmentationLoopManager.onSessionIdChanged: Update augmentation loop server on new ECS Session ID: '${this.$.ea.sessionId}'`),this.eM.forceReconnectSession(Object(e.a)(new A,{excelServerParameters:Object(e.a)(new v,{wacCluster:this.$.ya.MachineCluster,
ecsSessionId:this.$.ea.sessionId,ecsRestUrl:this.$.ya.RestActionUrl,ecsOperationUrl:"",metadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,userListVersion:0,collabStateId:0,accessToken:this.$.ya.AccessToken,accessTokenTTL:this.$.ya.AccessTokenValidTo.toString()})})).catch(lb=>{f.ULS.sendTraceTag(526406272,0,50,`AugmentationLoopManager.onSessionIdChanged: forceReconnectSession promise rejected with error ${lb}`)}),t.EwaSettings.isChangeGateEnabled("OfficeVSO:7578618_ObserverRequiredNotificationsToECSOnlyInEditMode")?
this.heb(this.isObserverRequired,"onSessionIdChanged"):(f.ULS.sendTraceTag(528348225,0,50,`AugmentationLoopManager.onSessionIdChanged: sending ObserverRequiredNotification, isSeedingRequired: ${this.isObserverRequired}`),this.heb(this.isObserverRequired)))};this.Zd=(Wa,Ma)=>{Wa=Object(Ba.p)(Ma.na)?Object(Ba.d)(Ma.na):this.activeWorksheetId;Ma=t.EwaSettings.isChangeGateEnabled("OfficeVSO:7547289_ALCloseALSessionOnInvalidAccessToken")?this.RBe()&&Wa&&Wa!==this.activeWorksheetId:Wa&&Wa!==this.activeWorksheetId;
this.activeWorksheetId=Wa;Ma&&(this.t9a=this.Ch.Zb,f.ULS.sendTraceTag(520677595,0,50,`AugmentationLoopManager.onActiveItemChanged: Submitting keepalive custom message. activeSheetId ${this.activeWorksheetId}`),this.u5f())};this.Wpc=(Wa,Ma,lb)=>{if(this.hxa){if(this.EP===Ea.Closed){f.ULS.shipAssertTag(509682971,0,!1,"AugmentationLoopManager.onCloseMessage: Called while augmentation loop server is closed. Avoiding with early return");return}f.ULS.sendTraceTag(509727633,0,50,`AugmentationLoopManager.onCloseMessage called with shouldRetry: ${Wa}, errorType: ${La[Ma]}, errorCode: ${lb}`);
if(Wa)this.XXd();else switch(Wa=this.CXe(Ma),this.uBe(Wa,lb),this.g2c(),Ma){case 3:this.s_a?(this.EP=Ea.ActiveForNonModelRequired,this.XXd()):(this.EP=Ea.ClosedAndWaitingOnlyForNonModelRequiredActivation,this.hPb());break;case 1:case 0:this.EP=Ea.Closed,this.hPb()}}else f.ULS.sendTraceTag(509649305,0,50,`AugmentationLoopManager.onCloseMessage called with shouldRetry: ${Wa}, errorType: ${La[Ma]}, errorCode: ${lb}`),Wa?(this.eM.startNewSession(),this.eLd()):(this.pZa.some(Na=>!Na.Au)||this.hPb(),Ma=
this.CXe(Ma),this.uBe(Ma,lb),this.g2c(),"ModelWorkflowNotSupported"===Ma&&(this.vmf=!1,this.eM.startNewSession(),this.eLd()));t.EwaSettings.isChangeGateEnabled("OfficeVSO:7578618_ObserverRequiredNotificationsToECSOnlyInEditMode")?this.heb(!1,"onCloseMessage"):this.$.ea.sessionId&&(f.ULS.sendTraceTag(520679430,0,50,"AugmentationLoopManager.onCloseMessage: sending ObserverRequiredNotification, isSeedingRequired: false"),this.heb(!1))};this.yc=(Wa,Ma)=>{if(Ma.Ef)f.ULS.sendTraceTag(520677599,0,50,"AugmentationLoopManager.onWorkbookClosing: event triggered due to silent reopen. Avoiding event with early return");
else if(f.ULS.sendTraceTag(537170381,0,50,`AugmentationLoopManager.onWorkbookClosing: handler invoked
      (IsAppBeforeUnload == ${this.$.OMa}, IsAppUnloading == ${this.$.eD}.`),this.$.OMa||this.$.eD)this.hPb(),this.g2c(),this.eM.closeSession().catch(lb=>{f.ULS.sendTraceTag(526406240,0,50,`AugmentationLoopManager.onWorkbookClosing: closeSession promise rejected with error ${lb}`)})};this.lHa=Wa=>{f.ULS.sendTraceTag(537170380,0,50,"Annotation Received");if(Wa)if(Wa.items){var Ma;({value:Ma}=this.$ma.Ic(da.a.rwa(Wa),0));if(0===Ma)f.ULS.sendTraceTag(537170377,0,10,"AugmentationLoopManager.annotationCallback: Operation Type not supported "+
da.a.rwa(Wa));else{var lb=!0;for(const X of Wa.items){if(!X){f.ULS.sendTraceTag(537170376,0,10,"AugmentationLoopManager.annotationCallback: Error in item");continue}if(!(da.a.eAd(Wa,[E.getTypeName()])||X.body&&this.Ypi(X.body))){f.ULS.sendTraceTag(537170375,0,10,"AugmentationLoopManager.annotationCallback: Body is either null or not an annotation.");continue}var Na=X.source;if(this.q_a.includes(Na)){f.ULS.sendTraceTag(520677597,0,50,`AugmentationLoopManager.annotationCallback: Filtered out annotation of owner ${Na}`);
continue}Na=da.a.rwa(X.body);if(!Na){f.ULS.sendTraceTag(523329624,0,50,"AugmentationLoopManager.annotationCallback: annotationType is null");continue}const F=X.body;if(!F){f.ULS.sendTraceTag(523329623,0,50,"AugmentationLoopManager.annotationCallback: annotation is null");continue}const na=new x(F,null,Wa.parentPath,Ma);lb=this.rLj(F)&&lb;f.ULS.sendTraceTag(576271178,0,50,`AugmentationLoopManager.annotationCallback: Triggering Event handler for Annotation ${Na}. Should report: ${lb}. ParentRevId: ${Wa.parentRevId}`);
this.B2b.Nvi(na.VG.id,Wa.parentRevId)&&(this.raiseEvent(this.Tzd(Na),na,this),f.ULS.sendTraceTag(520677596,0,100,`AugmentationLoopManager.annotationCallback: raising newAnnotation event (annotation type: ${Na})`));this.B2b.zDd(Na,na,Wa.parentRevId);this.raiseEvent(Na,na,this)}this.mmc&&lb&&(Wa=u.a(this.Ch,this.mmc.O2d),f.ULS.sendTraceTag(590906632,0,50,`AugmentationLoopManager.annotationCallback: Got valid annotation, time elapse from last state id(${this.mmc.stateId}): ${Wa}`))}}else f.ULS.sendTraceTag(537170378,
0,10,"AugmentationLoopManager.annotationCallback: Operation has no items");else f.ULS.sendTraceTag(537170379,0,10,"AugmentationLoopManager.annotationCallback: Operation is null")};this.Ow=(Wa,Ma)=>{-1!==Ma.Lzf&&(this.mmc=Object(e.a)(new k,{stateId:Ma.Lzf,O2d:this.Ch.Zb}))};this.fda=()=>{const Wa=u.b(this.Ch,this.t9a);if(t.EwaSettings.isChangeGateEnabled("OfficeVSO:7547289_ALCloseALSessionOnInvalidAccessToken"))var Ma=this.RBe()&&this.YAd<=Wa;else{Ma=this.$.ea.IZ;const lb=this.$.ea.hX;Ma=this.YAd<=
Wa&&lb<this.mUa&&!Ma}Ma?(this.t9a=this.Ch.Zb,f.ULS.sendTraceTag(509682396,0,50,`AugmentationLoopManager.onUserActivityThrottled: Submitting keepalive custom message. secondsSinceLastKeepAlive: ${Wa}`),this.Xhc?this.u5f():this.eM.submitCustomMessage(Object(e.a)(new H,{message:new ka})).catch(lb=>{f.ULS.sendTraceTag(509682395,0,50,`AugmentationLoopManager.onUserActivityThrottled: submitCustomMessage promise rejected with error ${lb}`)})):this.YAd<=Wa&&f.ULS.sendTraceTag(520632032,0,50,`AugmentationLoopManager.onUserActivityThrottled: Not submitting keepalive custom message. secondsSinceLastKeepAlive: ${Wa}`)};
this.vpc=(Wa,Ma)=>{Wa=Ma.VG;f.ULS.shipAssertTag(537170373,306,!!Wa,"AugmentationLoopManager.ObserverStatusAnnotationHandler: ObserverStatusAnnotation is null.");f.ULS.sendTraceTag(520677594,0,50,`AugmentationLoopManager.observerStatusAnnotationHandler: received ${JSON.stringify(Wa)}`);this.isObserverRequired=Wa.isSeedingRequired&&Wa.isObserverRequired;t.EwaSettings.isChangeGateEnabled("OfficeVSO:7578618_ObserverRequiredNotificationsToECSOnlyInEditMode")?this.heb(this.isObserverRequired,"observerStatusAnnotationHandler"):
this.$.ea.sessionId&&(f.ULS.sendTraceTag(520677593,0,50,`AugmentationLoopManager.observerStatusAnnotationHandler: sending ObserverRequiredNotification, isObserverRequired: ${this.isObserverRequired}`),this.heb(this.isObserverRequired))};this.WRb=(Wa,Ma)=>{var lb;(null===(lb=null===Ma||void 0===Ma?void 0:Ma.zd)||void 0===lb?0:lb.WorkbookCoauthVersion)&&this.$5i(Ma.zd.WorkbookCoauthVersion,Ma.context)};this.Ch=Ka||m.a.Ya;this.t9a=this.Ch.Zb;this.Xhc&&(this.activeWorksheetId=null!==(Pa=Object(Ba.d)(ma.na))&&
void 0!==Pa?Pa:this.activeWorksheetId);this.$=ma;this.eM=Ga;this.B2b=vb;f.ULS.sendTraceTag(520679433,0,50,`AugmentationLoopManager.constructor: setAnnotationResultCallback ${null===(fb=this.lHa)||void 0===fb?void 0:fb.name}, activeWorksheetId ${this.activeWorksheetId}`);this.eM.setAnnotationResultCallback(Object(e.a)(new C,{handler:this.lHa}));this.ami();this.$.ea.wA(this.Ow);this.$.ij(this.yc);this.mmc=Object(e.a)(new k,{stateId:0,O2d:this.Ch.Zb});this.$.da.Ha(328,this);this.YAd=this.$.ya.MinimumSecondsBetweenKeepAlivesFromBrowserToAugloop;
this.mUa=60*this.$.ya.UserActiveTimeSinceLastActivityInMinutes;this.$.ea.Oj(this.Wc);this.Xhc&&(this.$.Bb.Yf(this.Zd),this.$.ua.Yf(this.Zd));this.$.pa.kr(this.WRb);this.Hji();this.hxa?this.Fkj():(this.CKg(),this.tKg())}Hji(){t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugmentationLoopTableLint_PullFlowEnabled",!1)?this.q_a.push("TableLint-Grid-Column"):this.q_a.push("Tablelint-Column");t.EwaSettings.isChangeGateEnabled("OfficeVSO:7001231_IgnoreXlimVNextAnnotations")&&this.q_a.push("ExcelTableRecognitionReducer");
t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugmentationLoopTableLint_SecurityClassificationExcelGridPullWorkflow",!1)&&(t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.FilterOutLegacyLabellingAnnotation",!1)?this.q_a.push("SecurityLabellingReduce"):this.q_a.push("SecurityLabellingMetadataReduce"))}RBe(){const ma=this.$.ea.IZ;return 300>this.$.ea.hX&&!ma}u5f(){this.eM.submitCustomMessage(Object(e.a)(new H,{message:Object(e.a)(new ka,{activeWorksheetId:this.activeWorksheetId})})).catch(ma=>
{f.ULS.sendTraceTag(526406239,0,10,`AugmentationLoopManager.sendExcelKeepAliveMessage: submitCustomMessage promise rejected with error ${ma}`)})}O4a(){return new va}cLg(ma){ma.JK&&this.bYc(ma.annotationType,ma.JK);ma.j8&&this.D2.s2("Valid",ma.annotationType,ma.j8);ma.cla&&this.D2.s2("Invalid",ma.annotationType,ma.cla)}jmj(ma){ma.JK&&this.YMd(ma.annotationType,ma.JK);ma.j8&&this.D2.zna("Valid",ma.annotationType,ma.j8);ma.cla&&this.D2.zna("Invalid",ma.annotationType,ma.cla)}register(ma){if(this.hxa){var Ga=
null;let vb;this.wna.has(ma.featureName)?(Ga=`${ma.featureName} is already registered. Ignoring new registration.`,vb="AlreadyRegisteredFailure"):this.EP===Ea.Closed&&(Ga=`Augmentation loop server is permanently closed. Cannot register ${ma.featureName}.`,vb="ServerClosedFailure");if(Ga)return f.ULS.sendTraceTag(509649306,0,15,`AugmentationLoopManager.register: ${Ga}`),vb;f.ULS.sendTraceTag(509686223,0,50,`AugmentationLoopManager.register: Registering ${ma.featureName}`);this.wna.set(ma.featureName,
ma);ma.annotations.forEach(Ka=>this.vWf(ma.featureName,Ka))}else{this.Hpc.set(ma.featureName,ma.cH);for(Ga of ma.annotations)this.activateAnnotation(Object.assign(Object.assign({},Ga),{featureName:ma.featureName})),Ga.JK&&this.bYc(Ga.annotationType,Ga.JK),Ga.j8&&this.D2.s2("Valid",Ga.annotationType,Ga.j8),Ga.cla&&this.D2.s2("Invalid",Ga.annotationType,Ga.cla)}return"Success"}unregister(ma){if(this.hxa){const Ga=this.wna.get(ma);if(!Ga)return f.ULS.sendTraceTag(509686220,0,15,`AugmentationLoopManager.unregister: feature ${ma} is not registered`),
"UnregisteredFeatureFailure";f.ULS.sendTraceTag(509686221,0,50,`AugmentationLoopManager.unregister: unregister ${ma}`);Ga.annotations.forEach(vb=>{t.EwaSettings.isChangeGateEnabled("OfficeVSO:7589031_addUnregisterAnnotationMethod")?this.jmj(vb):(vb.JK&&this.YMd(vb.annotationType,vb.JK),vb.j8&&this.D2.zna("Valid",vb.annotationType,vb.j8),vb.cla&&this.D2.zna("Invalid",vb.annotationType,vb.cla))});this.wna.delete(ma);this.s_a=c(this.wna)}else this.Hpc.delete(ma),this.pZa.filter(Ga=>Ga.featureName===
ma).forEach(Ga=>{Ga.JK&&this.YMd(Ga.annotationType,Ga.JK);Ga.j8&&this.D2.zna("Valid",Ga.annotationType,Ga.j8);Ga.cla&&this.D2.zna("Invalid",Ga.annotationType,Ga.cla)});return"Success"}fqe(ma){this.Ipc.push(ma);f.ULS.sendTraceTag(520679432,0,50,`AugmentationLoopManager.addCloseCallback: ${null===ma||void 0===ma?void 0:ma.name}`)}CXe(ma){var Ga;return null!==(Ga=this.pHh.get(ma))&&void 0!==Ga?Ga:"Unknown"}eLd(){if(this.hxa)switch(this.EP){case Ea.FullyActive:this.wna.forEach(ma=>{ma.annotations.forEach(Ga=>
{this.activateAnnotation(Ga)})});break;case Ea.ActiveForNonModelRequired:this.wna.forEach(ma=>{ma.annotations.filter(Ga=>!Ga.Au).forEach(Ga=>{this.activateAnnotation(Ga)})});break;case Ea.ClosedAndWaitingOnlyForNonModelRequiredActivation:case Ea.Closed:f.ULS.shipAssertTag(509661458,0,!1,`AugmentationLoopManager.reactivateAnnotationsBasedOnModelSupported: Called while augmentation loop server is ${Ea[this.EP]}`)}else this.vmf?this.pZa.forEach(ma=>this.activateAnnotation(ma)):this.pZa.filter(ma=>!ma.Au).forEach(ma=>
this.activateAnnotation(ma))}Tzd(ma){return`New_${ma}ALManager`}bYc(ma,Ga){f.ULS.sendTraceTag(520679429,0,50,`AugmentationLoopManager.addNewAnnotationCallback: annotationType: ${ma}, handler: ${null===Ga||void 0===Ga?void 0:Ga.name}`);this.addHandler(this.Tzd(ma),Ga)}YMd(ma,Ga){this.hxa&&f.ULS.sendTraceTag(509686219,0,50,`AugmentationLoopManager.removeNewAnnotationCallback: annotationType: ${ma}, handler: ${null===Ga||void 0===Ga?void 0:Ga.name}`);this.removeHandler(this.Tzd(ma),Ga)}s2(ma,Ga){f.ULS.sendTraceTag(520679428,
0,50,`AugmentationLoopManager.addAnnotationCallback: annotationType: ${ma}, handler: ${null===Ga||void 0===Ga?void 0:Ga.name}`);this.addHandler(ma,Ga)}zna(ma,Ga){this.removeHandler(ma,Ga)}hqe(ma){f.ULS.sendTraceTag(520679427,0,50,"AugmentationLoopManager.addCoauthVersionChangedCallback");this.addHandler("CoauthVersionChangedALManager",ma)}vWf(ma,Ga){if(this.EP!==Ea.FullyActive&&Ga.Au)return f.ULS.sendTraceTag(509650462,0,50,`AugmentationLoopManager.registerAnnotationInternal: Augmentation loop server does not support model workflow. Cannot activate ${Ga.annotationType}.`),
!1;if(this.Sof)if(Ga.isInternal){if([Ea.ClosedAndWaitingOnlyForNonModelRequiredActivation,Ea.Closed].includes(this.EP))return!1}else this.s_a||(this.s_a=!Ga.Au),this.Tdg(!Ga.Au),this.VXd();else this.s_a||(this.s_a=!Ga.Au),this.Tdg(!Ga.Au),this.VXd();this.activateAnnotation(Object.assign(Object.assign({},Ga),{featureName:ma}));this.cLg(Ga);return!0}Uuc(ma,Ga){let vb=null,Ka;const Pa=this.wna.get(ma);Pa?Pa.annotations.some(fb=>Ga.annotationType===fb.annotationType)?(vb=`Annotation ${Ga.annotationType} is already registered for feature ${ma}.`,
Ka="AlreadyRegisteredFailure"):this.EP===Ea.Closed&&(vb=`Augmentation loop server is permanently closed. Cannot activate ${Ga.annotationType}.`,Ka="ServerClosedFailure"):(vb=`Feature ${ma} is not registered. Cannot register ${Ga.annotationType}.`,Ka="UnregisteredFeatureFailure");if(vb)return f.ULS.sendTraceTag(509682975,0,15,`AugmentationLoopManager.registerAnnotation: ${vb}`),Ka;f.ULS.sendTraceTag(509686218,0,50,`AugmentationLoopManager.registerAnnotation: Registering annotation ${Ga.annotationType} for feature ${ma}.`);
this.vWf(ma,Ga)&&Pa.annotations.push(Ga);return"Success"}XXd(){f.ULS.sendTraceTag(509661457,0,50,"AugmentationLoopManager.startNewALSession: Starting new AL session.");this.eM.startNewSession();this.VXd();this.eLd()}Tdg(ma){f.ULS.shipAssertTag(509650461,0,this.EP!==Ea.Closed,"AugmentationLoopManager.startNewALSessionIfNecessary: Called while augmentation loop server is closed permanently.");this.EP===Ea.ClosedAndWaitingOnlyForNonModelRequiredActivation&&ma&&(this.EP=Ea.ActiveForNonModelRequired,this.XXd())}mZa(ma){f.ULS.sendTraceTag(537170390,
0,50,`AugmentationLoopManager.activateAnnotationWithoutRegistration: activating annotation type: ${ma}.`);this.epe.has(ma)&&f.ULS.sendTraceTag(537170389,0,50,`AugmentationLoopManager.activateAnnotationWithoutRegistration: Annotations ${ma} were already activated in client session.`);this.epe.add(ma);this.He||(this.He=this.$.ea.He,this.He.S9(this.fda));this.eM.activateAnnotation(Object(e.a)(new y,{annotationType:ma,stateUpdateHandler:null})).then(Ga=>{Ga||f.ULS.sendTraceTag(537170388,0,10,"AugmentationLoopManager.activateAnnotationWithoutRegistration: ActivateAnnotationsResult is null");
return null}).catch(Ga=>{f.ULS.sendTraceTag(526406243,0,50,`AugmentationLoopManager.activateAnnotationWithoutRegistration: activateAnnotation promise rejected with error ${Ga}`)})}activateAnnotation(ma){f.ULS.sendTraceTag(520679425,0,50,`AugmentationLoopManager.activateAnnotation: Activating annotation type: ${ma.annotationType}.`);this.hxa||(this.pZa.includes(ma)?f.ULS.sendTraceTag(520679424,0,50,`AugmentationLoopManager.activateAnnotation: Annotations ${ma.annotationType} were already activated in client session.`):
this.pZa.push(ma),this.He||(this.He=this.$.ea.He,this.He.S9(this.fda)));t.EwaSettings.isChangeGateEnabled("OfficeVSO:6044361_XLALCatchPromiseFailures")?this.eM.activateAnnotation(Object(e.a)(new y,{annotationType:ma.annotationType,stateUpdateHandler:ma.eve})).then(Ga=>{Ga||f.ULS.sendTraceTag(520677603,0,10,"AugmentationLoopManager.activateAnnotation: ActivateAnnotationsResult is null");return null}).catch(Ga=>{f.ULS.sendTraceTag(520677602,0,50,`AugmentationLoopManager.activateAnnotation: activateAnnotation promise rejected with error ${Ga}`)}):
this.eM.activateAnnotation(Object(e.a)(new y,{annotationType:ma.annotationType,stateUpdateHandler:ma.eve})).then(Ga=>{Ga||f.ULS.sendTraceTag(520677601,0,10,"AugmentationLoopManager.activateAnnotation: ActivateAnnotationsResult is null");return null})}submitOperation(ma){if(this.qqd){if(!ma)return f.ULS.shipAssertTag(537170387,0,!1,"AugmentationLoopManager.submitOperation: operation is null"),"InvalidParameterFailure"}else f.ULS.shipAssertTag(537170387,0,!!ma,"AugmentationLoopManager.submitOperation: operation is null");
f.ULS.sendTraceTag(537170386,0,50,`AugmentationLoopManager.submitOperation: submitting operation of type '${da.a.rwa(ma)}'`);this.eM.submitOperation(Object(e.a)(new I,{operation:ma}));return"Success"}mPb(ma){if(this.qqd){if(!ma){f.ULS.shipAssertTag(537170385,0,!1,"AugmentationLoopManager.submitOperationSignal: signal is null");return}}else f.ULS.shipAssertTag(537170385,0,!!ma,"AugmentationLoopManager.submitOperationSignal: signal is null");const Ga=Object.getTypeName(ma);f.ULS.sendTraceTag(537170384,
0,50,`AugmentationLoopManager.submitOperationSignal: submitting operation signal of type '${Ga}'`);this.eM.submitOperation(Object(e.a)(new I,{operation:Object(e.a)(new ea.a,{parentPath:["Signal",Object.getTypeName(ma)],items:[Object(e.a)(new N.a,{body:ma})]})}))}registerLocalWorkflow(ma){if(this.qqd){if(!ma)return f.ULS.shipAssertTag(537170383,0,!1,"AugmentationLoopManager.registerLocalWorkflow: workflow is null"),"InvalidParameterFailure"}else f.ULS.shipAssertTag(537170383,0,!!ma,"AugmentationLoopManager.registerLocalWorkflow: workflow is null");
f.ULS.sendTraceTag(537170382,0,50,`AugmentationLoopManager.registerLocalWorkflow: registering local workflow '${ma.id}'`);this.eM.registerLocalWorkflow(Object(e.a)(new z,{workflow:ma}));return"Success"}Y7j(ma,Ga,vb,Ka){ma=Object(e.a)(new bb,{heightPx:Ka,widthPx:vb,contents:[Object(e.a)(new oa,{id:Ga+".0",format:2,size:3,sizeBytes:ma.length,data:ma})]});Ga=Object(e.a)(new N.a,{id:Ga,body:ma});Ga=Object(e.a)(new fa,{item:Ga});f.ULS.sendTraceTag(520677600,0,50,"AugmentationLoopManager.uploadImage: submitting custom message");
this.eM.submitCustomMessage(Object(e.a)(new H,{message:Ga})).catch(Pa=>{f.ULS.sendTraceTag(526406241,0,50,`AugmentationLoopManager.uploadImage: submitCustomMessage promise rejected with error ${Pa}`);return"UnknownFailure"})}get D2(){return this.B2b}dispose(){this.$&&this.$.ea&&this.$.ea.pk(this.Wc);this.$&&this.$.Bb&&this.Xhc&&(this.$.Bb.yg(this.Zd),this.$.ua.yg(this.Zd));this.$&&this.$.pa&&this.$.pa.zs(this.WRb);this.Ipc=[];this.Hpc.clear();this.hPb();super.dispose()}VXd(){this.He||(this.He=this.$.ea.He,
this.He.S9(this.fda));this.$.ea.wA(this.Ow)}hPb(){this.He&&(this.He.OAa(this.fda),this.He=null);this.$.ea.wB(this.Ow)}g2c(){for(let ma of this.Ipc)try{ma()}catch(Ga){f.ULS.sendTraceTag(528016151,0,10,`AugmentationLoopManager.callAndClearAugloopCloseCallbacks: caught exception with message: ${Ga.message}`)}this.Ipc=[]}uBe(ma,Ga){if(this.hxa)for(const vb of this.wna.values()){if(this.EP===Ea.FullyActive||!vb.annotations.every(Ka=>Ka.Au))try{vb.cH(ma,Ga)}catch(Ka){f.ULS.sendTraceTag(509674971,0,10,`AugmentationLoopManager.callAugloopCloseCallbacks: caught exception from ${vb.featureName} close callback with message: ${Ka.message}`)}}else for(const vb of this.Hpc.values())try{vb(ma,
Ga)}catch(Ka){f.ULS.sendTraceTag(509686216,0,10,String.format(`AugmentationLoopManager.callAugloopCloseCallbacks: caught exception with message: ${Ka.message}`))}}ami(){this.$ma=new Za.a;this.$ma.ia(P.a.getTypeName(),1);this.$ma.ia(Y.a.getTypeName(),2);this.$ma.ia(W.getTypeName(),5);this.$ma.ia(E.getTypeName(),3);this.$ma.ia(U.getTypeName(),7);this.$ma.ia(O.getTypeName(),6);this.$ma.ia(R.getTypeName(),4)}Ypi(ma){return da.a.rwa(ma)===S.a.getTypeName()||0<=Array.indexOf(da.a.A2e(ma),S.a.getTypeName())}rLj(ma){if(ma){if(t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.SharedOnline.AutoCLPV2Transition",
!1)){var Ga=!!ma.recommended&&!!ma.recommended.id;return!!ma.automatic&&!!ma.automatic.id||Ga}Ga=!!ma.recommended&&!!ma.recommended.sensitivityLabel&&!!ma.recommended.sensitivityLabel.id;return!!ma.automatic&&!!ma.automatic.sensitivityLabel&&!!ma.automatic.sensitivityLabel.id||Ga}return!1}Fkj(){this.register(this.O4a().xeb("ALManagerInternalAnnotations").ueb(()=>{}).activateAnnotation(this.Sof?{annotationType:L.getTypeName(),Au:!1,JK:this.vpc,isInternal:!0}:{annotationType:L.getTypeName(),Au:!1,JK:this.vpc}).build());
t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",!1)&&this.Uuc("ALManagerInternalAnnotations",{annotationType:"AugLoop_UnitTelemetry_UnitTelemetryAggregatedAnnotation",Au:!0});t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TablelintComparison",!1)&&this.Uuc("ALManagerInternalAnnotations",{annotationType:"AugLoop_Excel_ExcelComparisonAnnotation",Au:!0})}tKg(){t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",!1)&&this.activateAnnotation({annotationType:"AugLoop_UnitTelemetry_UnitTelemetryAggregatedAnnotation",
Au:!0});t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TablelintComparison",!1)&&this.activateAnnotation({annotationType:"AugLoop_Excel_ExcelComparisonAnnotation",Au:!0})}CKg(){this.activateAnnotation({annotationType:L.getTypeName(),Au:!0,JK:this.vpc});this.bYc(L.getTypeName(),this.vpc)}heb(ma,Ga=""){t.EwaSettings.isChangeGateEnabled("OfficeVSO:7578618_ObserverRequiredNotificationsToECSOnlyInEditMode")?this.$.isEditMode&&this.$.ea.sessionId&&(f.ULS.sendTraceTag(509371223,0,50,`AugmentationLoopManager.sendObserverRequiredNotification: isObserverRequired: ${this.isObserverRequired}, caller: ${Ga}`),
n(this.$.pa.va,ma,null,null,null,null)):n(this.$.pa.va,ma,null,null,null,null)}$5i(ma,Ga){if(this.SGc.DocId!==ma.DocId||this.SGc.Xluid!==ma.Xluid&&this.SGc.Xrevid!==ma.Xrevid)this.SGc=ma,this.raiseEvent("CoauthVersionChangedALManager",{coauthVersion:ma,userContext:Ga},this),this.B2b.Z5i(ma,Ga.userContext)}}Object(r.a)(pa,"AugmentationLoopManager",l.a,[595,3]);var $a=a(4),cb=a(392),ib=a(203),ta=a(158),Ya=a(31),Da=a(87),ba=a(52);class ya{constructor(){this.syncDeltaTimeout=this.disableSyncDeltaSending=
this.isDeltaGeneratorEnabled=this.powerpoint=this.downloadPolymerBaseUrl=this.inferenceServiceVersion=this.downloadBaseUrl=this.sessionCreationOptions=this.disabledServiceGroups=this.privateMode=this.flights=this.excelServer=this.initSession=this.sessionId=this.releaseFork=this.releaseCustomAudience=this.releaseChannel=this.releaseAudienceGroup=this.uiLanguage=this.appVersion=this.appName=this.serviceUrl=null}}Object(r.a)(ya,"InitializeParameters",null,[]);class V{constructor(){this.enableRemoteExecutionNotification=
this.networkMode=this.egress=this.localRegisteredWorkflows=this.enableComplexLocalWorkflows=this.serviceUrl=this.onServerAuthenticationStateChangeCallback=this.onSessionClose=this.onSessionReconnect=this.onSessionDisconnect=this.onSessionConnect=this.flights=this.extensionConfigs=this.docSessionId=null}}Object(r.a)(V,"SessionCreationOptions",null,[]);class Z{constructor(){this.featureEnabledCallback=null}}Object(r.a)(Z,"SetIsFeatureEnabledCallbackParameters",null,[]);class ja{constructor(){this.requestAuthTokenCallback=
null}}Object(r.a)(ja,"SetRequestAuthTokenCallbackParameters",null,[]);class la{constructor(){this.sendOTelEvent=null}}Object(r.a)(la,"SetSendOTelEventCallbackParameters",null,[]);class ua{constructor(){this.handler=null}}Object(r.a)(ua,"SetSessionInitOverrideCallbackParameters",null,[]);class eb{constructor(){this.ulsLogger=null}}Object(r.a)(eb,"SetULSLoggerParameters",null,[]);class Eb extends da.a{constructor(){super();this.activeWorksheetId=this.supportCustomMessages=this.accessTokenTTL=this.accessToken=
this.collabStateId=this.collabUserListVersion=this.configurations=this.permissionFlags=this.serverEventVersion=this.workbookMetadataVersion=this.ecsOperationUrl=this.restUrl=this.ecsId=this.cluster=null;this.H_=Object.assign(new G.a,{T_:Eb.getTypeName(),B_:Eb.Pd()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelServerSessionExtensionConfig"}static Pd(){return[]}}Object(r.a)(Eb,"ExcelServerSessionExtensionConfig",da.a,[]);var Wb=a(889),Ab=a(108);class Jb{static HEi(ma,Ga,vb){if(Jb.A2b)return f.ULS.sendTraceTag(537170369,
0,15,"augloop: LoadAndInitializeAugLoopRuntimeManager called more than once"),Jb.A2b;const Ka=$a.AFrameworkApplication.fa.Wa("AugLoopCloudALServiceUrl");if(!Ka||!Ka.length)return f.ULS.sendTraceTag(537170368,0,15,"AugmentationLoopRuntimeProxy.LoadAndInitializeAugLoopRuntimeManager: AugLoopCloudALServiceUrl is null or empty"),Promise.reject(null);vb=Ab.a(ba.a.loadScript(83,4,vb,void 0,void 0,327));Jb.A2b=vb.then(()=>{const Pa=augLoop.ALFactoryGlobal.getAugLoopRuntimeManager();Jb.Ski(ma,Ga,Pa);return Promise.resolve(Pa)}).catch(Pa=>
{f.ULS.sendTraceTag(537170339,0,10,"augloop: Failed to download script:"+Pa);return Promise.reject(null)});return Jb.A2b}static Ski(ma,Ga,vb){var Ka;f.ULS.sendTraceTag(537170338,0,50,"augloop: Successfully loaded script");Jb.Ch||Jb.rCj(m.a.Ya);Jb.Srd=new Set;f.ULS.sendTraceTag(522803219,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: setIsFeatureEnabledCallback");vb.setIsFeatureEnabledCallback(Object(e.a)(new Z,{featureEnabledCallback:fb=>{const Wa=$a.AFrameworkApplication.fa.qa("AugLoop"+
fb),Ma=t.EwaSettings.getBooleanFeatureGate(fb,!1),lb=t.EwaSettings.getBooleanFeatureGate("AugLoop"+fb,!1),Na=Ma||lb,X=Wa||Na;Jb.Srd.has(fb)||(Jb.Srd.add(fb),f.ULS.shipAssertTag(537170337,0,!(Wa&&!Na),`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager.isFeatureEnabled: legacy app setting return true for feature ${fb}, but feature gate return false. This is problem because app setting is depricated and about to be removed`),X&&f.ULS.sendTraceTag(537170336,0,50,`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager.isFeatureEnabled: feature ${fb} is enabled. legacyAppSettingResult: ${Wa}, featureGateWithoutPrefix: ${Ma}, featureGateWithPrefix: ${lb}`));
return X}}));if(t.EwaSettings.xa(379))if(Ga){var Pa=Jb.Fcc(Ga);Pa=Jb.Fcc(Ga,$a.AFrameworkApplication.fa.Wa("AugloopACLPUserDataSignature"));f.ULS.sendTraceTag(522803218,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: Callback is passed to the augloop runtime which calls the code  when an auth token is required");vb.setRequestAuthTokenCallback(Object(e.a)(new ja,{requestAuthTokenCallback:Pa}))}else f.ULS.sendTraceTag(537170335,0,10,"Oauth manager is null");f.ULS.sendTraceTag(522803217,
0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setULSLogger");vb.setULSLogger(Object(e.a)(new eb,{ulsLogger:new cb.a}));f.ULS.sendTraceTag(522803216,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSendOTelEventCallback");vb.setSendOTelEventCallback(Object(e.a)(new la,{sendOTelEvent:Jb.sendOTelEvent}));Ga=new Map;Pa=t.EwaSettings.AYh();for(const [fb,Wa]of Pa)Ga.set(fb,String(Wa));t.EwaSettings.xa(381)&&Ga.set("AugmentationLoopObserverSession",
void 0);t.EwaSettings.xa(422)&&Ga.set("AugmentationLoopIncrementalUpdates",void 0);t.EwaSettings.xa(387)&&Ga.set("EnterpriseDataTypeMipSupport",void 0);(t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.ExcelOnline.TableLintExperiment",!1)||t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.ExcelOnline.TableLintProdExperiment",!1)||t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligence",!1)||t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",
!1))&&Ga.set("LoadAdditionalDataToModel",void 0);t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.DataCleansingTaskPane",!1)&&(Ga.set("DataCleansingSlice0",void 0),Ga.set("LoadAdditionalDataToModel",void 0));t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugloopNoLatency",!1)&&Ga.set("AugloopNoLatency",void 0);t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableLintInvestigationTelemetry",!1)&&Ga.set("TableLintInvestigationTelemetry",void 0);t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TelemetryWorkflowIncludeTextHints",
!1)&&Ga.set("TelemetryWorkflowIncludeTextHints",void 0);t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.Insights.UseTableRecoMLTableIntelligence",!1)&&Ga.set("UseTableRecoMLTableIntelligence",void 0);t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligenceLogging",!1)&&Ga.set("TableIntelligenceLogging",void 0);t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugloopWaitForWorkbookChangeState",!1)&&Ga.set("AugloopWaitForWorkbookChangeState",void 0);t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.XLALReadMetadataFromUserEcsSession",
!1)&&Ga.set("XLALReadMetadataFromUserEcsSession",void 0);t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.XLALWorksheetScopingEnable",!1)&&Ga.set("XLALWorksheetScopingEnable",void 0);t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UseTableSenseML",!1)&&Ga.set("UseTableSenseML",void 0);t.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligenceSheetCountThreshold",!1)&&(null===(Ka=null===ma||void 0===ma?void 0:ma.ua)||void 0===Ka?0:Ka.count)&&ma.ua.count>t.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.TableIntelligenceSheetCountThresholdValue",
100)&&(Ga.set("TableIntelligenceSheetCountThreshold",void 0),f.ULS.sendTraceTag(521151777,306,50,`TableIntelligence max sheet count exceeded. SheetCount: ${ma.ua.count}`));Ka=t.EwaSettings.uXh();for(const fb of Ka)Ga.set(fb,"false");f.ULS.sendTraceTag(522803215,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setInitSessionCallback");vb.setInitSessionCallback({initSessionCallback:()=>{var fb;if(null===(fb=null===ma||void 0===ma?void 0:ma.ea)||void 0===fb?0:fb.sessionId)return f.ULS.sendTraceTag(527708568,
0,50,`AugmentationLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is valid (length = ${ma.ea.sessionId.length}), return resolved promise`),Promise.resolve();f.ULS.sendTraceTag(527708567,0,50,"AugmentationLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is not valid, return promise that will be resolved when session id will be valid again.");return new Promise(Wa=>{var Ma;const lb=()=>{var Na;(null===(Na=null===ma||void 0===ma?void 0:ma.ea)||
void 0===Na?0:Na.sessionId)?(f.ULS.sendTraceTag(527708566,0,50,`AugmentationLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called with valid session id (length = ${ma.ea.sessionId.length}), resolve the promise and unregister the callback.`),ma.ea.pk(lb),Wa()):f.ULS.sendTraceTag(527708565,0,50,"AugmentationLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called, but the session id is not valid yet, keep waiting.")};null===(Ma=null===ma||void 0===ma?void 0:ma.ea)||
void 0===Ma?void 0:Ma.Oj(lb)})}});f.ULS.sendTraceTag(522803214,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSessionInitOverrideCallback");vb.setSessionInitOverrideCallback(Object(e.a)(new ua,{handler:fb=>{var Wa;fb.extensionConfigs=[Object(e.a)(new Eb,{cluster:ma.ya.MachineCluster,ecsId:Jb.TXh(ma),restUrl:ma.ya.RestActionUrl,ecsOperationUrl:"",workbookMetadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,collabUserListVersion:0,collabStateId:0,
accessToken:ma.ya.AccessToken,accessTokenTTL:ma.ya.AccessTokenValidTo.toString(),activeWorksheetId:t.EwaSettings.isChangeGateEnabled("OfficeVSO:7403069_ALSendActiveWorksheetId")?null!==(Wa=Object(Ba.d)(ma.na))&&void 0!==Wa?Wa:void 0:void 0})];t.EwaSettings.isChangeGateEnabled("OfficeVSO:7403069_ALSendActiveWorksheetId")?f.ULS.sendTraceTag(509682397,0,50,`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: access token TTL ${ma.ya.AccessTokenValidTo.toString()}, activeWorksheetId ${Object(Ba.d)(ma.na)}`):
f.ULS.sendTraceTag(537170334,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: access token TTL "+ma.ya.AccessTokenValidTo.toString());return fb}}));f.ULS.sendTraceTag(522803213,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.initialize - onSessionClose: getOnCloseMessageCallback ");vb.initialize(Object(e.a)(new ya,{serviceUrl:$a.AFrameworkApplication.fa.Wa("AugLoopCloudALServiceUrl"),appName:"Excel",appVersion:$a.AFrameworkApplication.fa.Wa("BuildVersion")||
"",releaseAudienceGroup:$a.AFrameworkApplication.Ub?Object(Da.a)(String,$a.AFrameworkApplication.Ub.AudienceGroup)||"":"",releaseChannel:null,releaseFork:null,sessionId:ma.ya.UserSessionId,initSession:!0,flights:this.Qch(Ga),uiLanguage:$a.AFrameworkApplication.uiCulture,excelServer:null,sessionCreationOptions:Object(e.a)(new V,{onSessionClose:Jb.Y2h()})}))}static Qch(ma){return Array.from(ma.entries()).map(([Ga,vb])=>void 0!==vb?`${Ga}:${vb}`:Ga).map(Ga=>Ga+";").join("")}static Y2h(){return ma=>{let Ga=
!ib.a.instance.hR($a.AFrameworkApplication.Nj);const vb=null===ma||void 0===ma?void 0:ma.reason;Ga?ma?ma.reason&&(f.ULS.shipAssertTag(509658147,0,!(void 0===vb.errorType||null===vb.errorType),"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: closeReason.errorType is null"),Ga&&(Ga=null==vb.errorType||2===vb.errorType)):f.ULS.shipAssertTag(537170331,0,!1,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: - closeMessage is null"):f.ULS.sendTraceTag(537170330,0,15,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: access token has expired");
f.ULS.sendTraceTag(509727632,0,50,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: is called with shouldRetry: ${Ga},
        errorType: ${La[null===vb||void 0===vb?void 0:vb.errorType]},
        errorCode: ${null===vb||void 0===vb?void 0:vb.errorCode},
        isExpected: ${null===vb||void 0===vb?void 0:vb.isExpected}`);Ga&&((!Jb.cQb||u.a(Jb.Ch,Jb.cQb)>Jb.vVf)&&Jb.wtj(),Jb.Huc<Jb.kAd?(Jb.Huc++,f.ULS.sendTraceTag(537170328,0,50,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: Start new session attempt ${Jb.Huc} of ${Jb.kAd}. Time of first attempt in this interval of reconnects: ${Jb.cQb}`)):(f.ULS.sendTraceTag(537170327,0,15,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: Reached the limit of ${Jb.kAd} attempts for session creation under interval of ${Jb.vVf} Ms. Stop trying to reconnect. Time of first attempt in this iterval: ${Jb.cQb}.`),
Ga=!1));Jb.lDf(Ga,null===vb||void 0===vb?void 0:vb.errorType,null===vb||void 0===vb?void 0:vb.errorCode)}}static tCj(ma){Jb.lDf=ma}static rCj(ma){Jb.Ch=ma}static wtj(){Jb.Huc=0;Jb.cQb=Jb.Ch.Zb}static Fcc(ma,Ga=""){return()=>{try{return f.ULS.sendTraceTag(527970953,0,50,`AugmentationLoopRuntimeProxy.getAuthTokenDelegate: called with fallbackValue.length: ${Ga.length}.`),ma.tL("AugLoop",$a.AFrameworkApplication.fa.Wa("AugLoopOAuthResourceUriV2")).then(vb=>{if(vb.IsSuccess)return f.ULS.sendTraceTag(527970952,
0,50,"AugmentationLoopRuntimeProxy.getAuthTokenDelegate: successfully fetch token."),vb.Token;f.ULS.sendTraceTag(537170326,0,15,`AugmentationLoopRuntimeProxy.getAuthTokenDelegate: failed to get token, use fallback value (length: ${Ga.length})`);return Ga},()=>{f.ULS.sendTraceTag(537170325,0,15,"AugmentationLoopRuntimeProxy.getAuthTokenDelegate: got rejected promise, use fallback value");return Ga})}catch(vb){return f.ULS.sendTraceTag(537170324,0,10,"Exception thrown when fetching token"),Promise.resolve(Ga)}}}static sendOTelEvent(ma){ta.a.sendOtelEvent(Object(e.a)(new Wb.a,
{otelEvent:ma}))}static TXh(ma){const Ga=Ya.a.pf(ma.ea.sessionId);ma=`cluster=${ma.ya.MachineCluster}&session=${Ga}&usid=${ma.ya.UserSessionId}`;t.EwaSettings.isChangeGateEnabled("OfficeVSO:5897059_XLALInvestigateIncorrectSessionId")&&f.ULS.sendTraceTag(528348230,0,50,`AugmentationLoopRuntimeProxy.getEcsSessionId: ecsSessionId length is ${ma.length}`);return ma}}Jb.kAd=3;Jb.vVf=3E5;Jb.Huc=0;Jb.cQb=null;Jb.Ch=null;Jb.A2b=null;Jb.lDf=null;Jb.Srd=null;Object(r.a)(Jb,"AugmentationLoopRuntimeProxy",null,
[]);var Gb=a(50),Nb=a(38),Ja=a(199),ab;(function(ma){ma.newAnnotation="New";ma.validAnnotation="Valid";ma.invalidAnnotation="Invalid"})(ab||(ab={}));Object(r.b)("AnnotationCallbackType",ab);var wb;(function(ma){ma.newAnnotation="New";ma.validOnArrivalAnnotation="ValidOnArrival";ma.validAfterSomeTimeAnnotation="ValidAfterSomeTime";ma.invalidOnCoauthVersionChangedAnnotation="InvalidOnCoauthVersionChanged";ma.invalidAfterTimeoutAnnotation="InvalidAfterTimeout"})(wb||(wb={}));Object(r.b)("AnnotationEventType",
wb);var xb;(function(ma){ma[ma.beforeAnnotation=0]="beforeAnnotation";ma[ma.atAnnotation=1]="atAnnotation";ma[ma.afterAnnotation=2]="afterAnnotation"})(xb||(xb={}));Object(r.b)("TimelinePosition",xb);class rb{constructor(){this.ngb=new Map;f.ULS.sendTraceTag(520176320,0,50,"AugmentationLoopAnnotationValidatorLogger.constructor: called")}Wpe(ma){this.ngb.has(ma)||(f.ULS.sendTraceTag(520176291,0,50,`AugmentationLoopAnnotationValidatorLogger.addAnnotationType: ${ma}`),this.ngb.set(ma,[]))}kmj(ma){this.ngb.delete(ma)&&
f.ULS.sendTraceTag(520176290,0,50,`AugmentationLoopAnnotationValidatorLogger.removeAnnotationType: ${ma}`)}v0i(ma,Ga){ma.find(vb=>vb.annotationId===Ga)||ma.push({annotationId:Ga,cYj:Date.now(),I1b:wb.newAnnotation})}sHi(ma,Ga,vb,Ka){f.ULS.sendTraceTag(520176289,0,50,`AugmentationLoopAnnotationValidatorLogger.logLatencyEntry: type: ${ma}, entry: (${Ga.annotationId} ${Ga.I1b}) incoming: ${Ka}, latency: ${vb-Ga.cYj} ms`)}Qfi(ma,Ga,vb){return(vb===wb.validAfterSomeTimeAnnotation||vb===wb.validOnArrivalAnnotation)&&
(ma.annotationId===Ga||ma.I1b===wb.invalidAfterTimeoutAnnotation)}i5i(ma,Ga,vb,Ka){let Pa=[];const fb=Date.now();let Wa=xb.beforeAnnotation;for(let Ma of Ga){this.Qfi(Ma,vb,Ka)&&this.sHi(ma,Ma,fb,Ka);if(Ma.annotationId===vb){Ma.I1b=Ka;if(Ka===wb.invalidAfterTimeoutAnnotation)return;Wa=xb.atAnnotation}else Wa===xb.atAnnotation&&(Wa=xb.afterAnnotation);Ga=Ka===wb.invalidOnCoauthVersionChangedAnnotation?Ma.annotationId!==vb:Ma.I1b===wb.newAnnotation;const lb=Wa===xb.afterAnnotation;(Wa!==xb.afterAnnotation&&
Ga||lb)&&Pa.push(Ma)}this.ngb.set(ma,Pa)}zSi(ma,Ga,vb){let Ka=this.ngb.get(ma);Ka||(this.Wpe(ma),Ka=this.ngb.get(ma));vb===wb.newAnnotation?this.v0i(Ka,Ga):this.i5i(ma,Ka,Ga,vb)}}Object(r.a)(rb,"AugmentationLoopAnnotationValidatorLogger",null,[]);class za{constructor(ma,Ga){this.toString=()=>JSON.stringify(this);this.annotationId=ma;this.coauthVersion=Ga}}Object(r.a)(za,"LocalAnnotationId",null,[]);class Aa extends l.a{constructor(ma=36E5){super();this.eOa=new Map;this.l_=new Map;this.CPa=new Set;
this.e3d=new rb;this.qYe=ma;f.ULS.sendTraceTag(523337872,0,50,`AugmentationLoopAnnotationValidator.constructor: annotationExpirationTimeout: ${this.qYe} ms`)}dispose(){f.ULS.sendTraceTag(523337871,0,50,`AugmentationLoopAnnotationValidator.dispose: ${this.getStatus()}`);this.CPa.clear();this.l_.clear();this.eOa.clear();super.dispose()}hqe(ma){f.ULS.sendTraceTag(521405910,0,50,"AugmentationLoopAnnotationValidator.addCoauthVersionChangedCallback");this.addHandler("CoauthVersionChanged",ma)}s2(ma,Ga,
vb){f.ULS.sendTraceTag(521405908,0,50,`AugmentationLoopAnnotationValidator.addAnnotationCallback: annotationType: ${Ga}`);this.addHandler(this.Rzd(ma,Ga),vb);t.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&this.e3d.Wpe(Ga)}zna(ma,Ga,vb){f.ULS.sendTraceTag(521405907,0,50,`AugmentationLoopAnnotationValidator.removeAnnotationCallback: annotationType: ${Ga}`);this.removeHandler(this.Rzd(ma,Ga),vb);t.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&
this.e3d.kmj(Ga)}Z5i(ma,Ga){f.ULS.sendTraceTag(523337870,0,50,`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: starting, raising CoauthVersionChanged event: ${b(ma)}`);this.raiseEvent("CoauthVersionChanged",{coauthVersion:ma,userContext:Ga},this);this.Coi(this.U7b);this.U7b=ma;this.M9j(this.U7b);this.Zhf();f.ULS.sendTraceTag(523337869,0,50,`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: done ${this.getStatus()}`)}CYe(ma){if(ma)try{const Pa=JSON.parse(ma);var Ga=
Pa.coauthVersionDocId,vb=Pa.coauthVersionXluid,Ka=Pa.coauthVersionXrevId;return{DocId:"undefined"===Ga?void 0:Ga,Xluid:"undefined"===vb?void 0:vb,Xrevid:"undefined"===Ka?void 0:parseInt(Ka,10)}}catch(Pa){f.ULS.sendTraceTag(523337868,0,10,`AugmentationLoopAnnotationValidator.extractWorkbookCoauthVersion(${ma}): Exception - ${Pa}`)}}zDd(ma,Ga,vb){vb=this.CYe(vb);void 0!==vb&&(f.ULS.sendTraceTag(523337867,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: starting ${ma}: ${Ga.operationType}: (annotation id ${Ga.VG.id}) at ${b(vb)}`),
this.NMg({annotationType:ma,cve:Ga},vb),this.Zhf(),f.ULS.sendTraceTag(523337866,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: done ${this.getStatus()}`))}Rzd(ma,Ga){return`${ma}_${Ga}`}getStatus(){var ma,Ga;const vb=b(this.U7b),Ka=null===(ma=this.eOa)||void 0===ma?void 0:ma.size;ma=null===(Ga=this.CPa)||void 0===Ga?void 0:Ga.size;return`current coauth version: ${vb}, ${Ka} known annotations, ${ma} coauth versions on hold`}FJb(ma,Ga,vb,Ka){const Pa=this.eOa.get(`${Ga}`);ma=this.Rzd(ma,
Pa.annotationType);f.ULS.sendTraceTag(523337865,0,50,`AugmentationLoopAnnotationValidator.raiseAnnotationEvent: ${vb} raising ${ma} event (annotation id: ${Ga})`);this.raiseEvent(ma,Pa.cve,this);t.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&this.e3d.zSi(Pa.annotationType,`${Ga}`,Ka)}Nvi(ma,Ga){Ga=b(this.CYe(Ga));ma=`${new za(ma,Ga)}`;return!this.eOa.has(ma)}NMg(ma,Ga){var vb=ma.cve.VG.id;const Ka=b(Ga);vb=new za(vb,Ka);const Pa=`${vb}`;this.eOa.has(Pa)?
f.ULS.sendTraceTag(523337864,0,50,`AugmentationLoopAnnotationValidator.addNewAnnotation: ignoring duplicate annotation (annotation id ${vb})`):(this.eOa.set(Pa,ma),this.l_.has(Ka)?this.l_.get(Ka).mHa.add(vb.annotationId):this.l_.set(Ka,{mHa:new Set([vb.annotationId]),timestamp:Date.now()}),this.FJb("New",vb,"addNewAnnotation","New"),ma=this.U7b,Ga===ma||Ga&&ma&&Ga.DocId===ma.DocId&&Ga.Xluid===ma.Xluid&&Ga.Xrevid===ma.Xrevid?this.FJb("Valid",vb,"addNewAnnotation","ValidOnArrival"):this.CPa.add(b(Ga)))}PXf(ma){this.eOa.delete(`${ma}`);
for(let [Ga,vb]of this.l_.entries())if(Ga===ma.coauthVersion&&vb.mHa.delete(ma.annotationId))break}snj(){Array.from(this.l_.entries()).filter(([,ma])=>0===ma.mHa.size).forEach(([ma])=>this.l_.delete(ma))}VXf(ma){this.CPa.delete(ma)}Coi(ma){var Ga;const vb=b(ma);(new Set(null===(Ga=this.l_.get(vb))||void 0===Ga?void 0:Ga.mHa)).forEach(Ka=>{Ka=new za(Ka,vb);this.FJb("Invalid",Ka,"invalidateAnnotations","InvalidOnCoauthVersionChanged");this.PXf(Ka)})}M9j(ma){var Ga;ma=b(ma);if(this.CPa.has(ma)){var vb=
null===(Ga=this.l_.get(ma))||void 0===Ga?void 0:Ga.mHa;Ga=(Ga=this.l_.get(ma))?Date.now()-Ga.timestamp:0;for(const Ka of vb)vb=new za(Ka,ma),this.FJb("Valid",vb,`validateAnnotations elapsed ${Ga} ms`,"ValidAfterSomeTime");this.VXf(ma)}else f.ULS.sendTraceTag(523337863,0,50,`AugmentationLoopAnnotationValidator.validateAnnotations: ${ma} has no on-hold annotations associated with it`)}Zhf(){var ma=Date.now();const Ga=[],vb=[];for(const Pa of this.CPa){var Ka=this.l_.get(Pa);const fb=ma-Ka.timestamp;
if(fb>this.qYe)for(const Wa of Ka.mHa)Ka=new za(Wa,Pa),this.FJb("Invalid",Ka,`invalidateExpiredAnnotations elapsed ${fb} ms`,"InvalidAfterTimeout"),Ga.push(Ka)}for(const Pa of Ga)this.PXf(Pa);for(const Pa of this.CPa)ma=this.l_.get(Pa),0===(null===ma||void 0===ma?void 0:ma.mHa.size)&&vb.push(Pa);for(const Pa of vb)this.VXf(Pa);this.snj()}}Object(r.a)(Aa,"AugmentationLoopAnnotationValidator",l.a,[547]);var pb=a(153),kb=a(54),Cb=a(70);class ob extends B.a{constructor(ma){super();this.augmentationLoopManager=
null;this.$=ma;this.Gb();f.ULS.sendTraceTag(520939607,0,50,"AugmentationLoopManagerFactory.constructor: called")}create(){const ma=Date.now();d.Health.instance.recordKpiUsageForAlertableKpi("AugmentationLoopManagerCreation","xlalint",null);f.ULS.sendTraceTag(537170371,0,50,"AugmentationLoopManagerFactory.create: called");let Ga=null;const vb=[];t.EwaSettings.xa(379)&&(Ga=Object(Cb.b)("OfficeVSO:7624847_MigrateOAuthToNewServiceInfra")?Object(Ab.c)(pb.a.resolve(kb.D,{Wb:this.Na})):Gb.GetServiceTaskFactory.Pa(this.$.da,
349,350,this.Na),vb.push(Ga));Nb.TaskExtensions.za(Nb.TaskExtensions.Md(vb,this.ka,3),()=>{Jb.HEi(this.$,Ga?Ga.result:null,this.Na).then(Ka=>{f.ULS.sendTraceTag(537170370,0,50,"AugmentationLoopManagerFactory.create: Augmentation Loop runtime initialized");try{this.qb(this.augmentationLoopManager||(this.augmentationLoopManager=new pa(this.$,Ka,new Aa(this.$.ya.AugmentationLoopAnnotationExpirationTimeoutInMs)))),Jb.tCj(this.augmentationLoopManager.Wpc)}catch(Pa){d.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation",
"Exception",!1,!0,Object(e.a)(new Ja.a,{extendedProperties:new Map,durationMs:Date.now()-ma})),this.qb(null),f.ULS.sendTraceTag(42796228,0,10,`AugmentationLoopManagerFactory.create: Augmentation loop initialization failed. Exception ${Pa.message}`)}}).catch(()=>{d.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation","PromiseRejected",!1,!0,Object(e.a)(new Ja.a,{extendedProperties:new Map,durationMs:Date.now()-ma}));this.qb(null);f.ULS.sendTraceTag(42796229,0,10,"AugmentationLoopManagerFactory.create: Augmentation loop initialization failed")})},
this.$.ka,3)}static la(ma){f.ULS.sendTraceTag(520939606,0,50,"AugmentationLoopManagerFactory.attach: called");ma.da.Ha(327,new ob(ma))}}Object(r.a)(ob,"AugmentationLoopManagerFactory",B.a,[]);var qa=a(9);a=a(1185);Type.registerNamespace("_Ewa");(()=>{qa.a.Fa(ma=>{ob.la(ma)})})();Object(a.a)()},839:function(r,B,a){a.d(B,"h",function(){return d});a.d(B,"g",function(){return l});a.d(B,"f",function(){return k});a.d(B,"b",function(){return w});a.d(B,"c",function(){return n});a.d(B,"e",function(){return x});
a.d(B,"d",function(){return m});a.d(B,"a",function(){return t});r=a(0);var c=a(11),b=a(327),e=a(15),f=a(33);const d=(z,C,H,I)=>{e.ULS.sendTraceTag(221794372,306,20,`FormulaByExample suggestion display failure reported. Failure data ${JSON.stringify({["flowId"]:z.flowId,["originFormulaFlowId"]:z.hda.flowId,["formulaAnonymized"]:z.anonymizedFormula,["originalFormulaAnonymized"]:z.hda.anonymizedFormula,["range"]:z.range,["failureReason"]:C})}`);H&&H.vp(z.flowId,I,{reason:C})};var h;(function(z){z.EXAMPLE=
"EXAMPLE";z.MODIFIEDEXAMPLE="MODIFIEDEXAMPLE";z.RESTOFRANGE="RESTOFRANGE";z.MODIFIEDRESTOFRANGE="MODIFIEDRESTOFRANGE"})(h||(h={}));Object(r.b)("suggestionCellType",h);const l=(z,C,H,I,S,P)=>{e.ULS.sendTraceTag(512350163,0,50,`Cell data didn't match suggestion output on FlowId: ${S.flowId}. cellType: ${P} caller: ${I}:
      CellData: ${A(z)}, CellFormatIndex: ${H}, SuggestionOutput: ${A(C)},
      SuggestedFormula: ${S.anonymizedFormula}}`)},k=(z,C,H)=>{try{const I=y(z,C,H);window.performance.mark(I)}catch(I){e.ULS.sendTraceTag(529109767,0,10,`FormulaByExampleTelemetryGenerator.markPerformancePoint: Error thrown : ${I.message}`)}},w=z=>{for(const C in u)try{window.performance.clearMarks(y(C,z,!1)),window.performance.clearMarks(y(C,z,!0))}catch(H){e.ULS.sendTraceTag(527005662,0,10,`FormulaByExampleTelemetryGenerator.clearPerformanceFlowMarks: Error thrown : ${H.message}`)}},n=z=>v(`FBE_flowCurrentDuration_${z}`,
y(u.EditCommit,z,!1)),x=(z,C)=>{try{return{["EditCommitToSignal"]:v(`FBE_EditCommitToSignal_${C}_${z}`,y(u.EditCommit,C,!1),y(u.SignalSent,C,!1)),["WorkflowAndNetworkTime"]:z?0:v(`FBE_WorkflowAndNetworkTime_${C}_${z}`,y(u.SignalSent,C,!1),y(u.AnnotationReceived,C,!1)),["Calculation"]:v(`FBE_Calculation_${C}_${z}`,y(u.CalculationStart,C,z),y(u.CalculationEnd,C,z)),["ModelUpdate"]:v(`FBE_ModelUpdate_${C}_${z}`,y(u.CalculationEnd,C,z),y(u.ModelUpdated,C,z)),["PreviewRender"]:v(`FBE_PreviewRendered_${C}_${z}`,
y(u.ModelUpdated,C,z),y(u.PreviewRendered,C,z)),["Total"]:v(`FBE_Total_${C}_${z}`,y(u.EditCommit,C,!1),y(u.PreviewRendered,C,z))}}catch(H){e.ULS.sendTraceTag(529109766,0,10,`FormulaByExampleTelemetryGenerator.getPreviewShownDurations: Error thrown : ${H.message}`)}},m=(z,C)=>{try{return{["UserInPreviewDuration"]:v(`FBE_InputToPreviewRemovedWithCSE_${C}_${z}`,y(u.PreviewRendered,C,z),y(u.UserInputArrived,C,z)),["InputToPreviewRemovedWithCSE"]:v(`FBE_InputToPreviewRemovedWithCSE_${C}_${z}`,y(u.UserInputArrived,
C,z),y(u.PreviewRemovedWithCSE,C,z))}}catch(H){e.ULS.sendTraceTag(529109765,0,10,`FormulaByExampleTelemetryGenerator.getPreviewRemovedDurations: Error thrown : ${H.message}`)}};var u;(function(z){z.EditCommit="EDITCOMMIT";z.SignalSent="SIGNALSENT";z.AnnotationReceived="ANNOTATIONRECEIVED";z.CalculationStart="CALCULATIONSTART";z.CalculationEnd="CALCULATIONED";z.ModelUpdated="MODELUPDATED";z.PreviewRendered="PREVIEWRENDERED";z.UserInputArrived="USERINPUTARRIVED";z.PreviewRemovedWithCSE="PREVIEWREMOVEDWITHCSE"})(u||
(u={}));Object(r.b)("FormulaByExampleFlowMarks",u);const t=z=>c.HelperMethods.n1c&&b.a.grb&&f.a.kjc(z),y=(z,C,H)=>`${z}_${C+(H?"_cached":"")}`,v=(z,C,H)=>{const I=window.performance.measure(z,C,H);if(I)return C=I.duration,performance.clearMeasures(z),C;e.ULS.sendTraceTag(526984791,0,15,`FormulaByExampleTelemetryGenerator.measureTime: could not find performance entry for measure: ${z}, startMark: ${C}, endMark: ${H}`);return-1},A=z=>z.replace(RegExp("[0-9a-zA-Z]","g"),C=>"a"<=C&&"z">=C?"a":"A"<=C&&
"Z">=C?"A":"0"<=C&&"9">=C?"9":C)},874:function(r,B,a){r=a(0);var c=a(15),b=a(429),e=a(1),f;(function(I){I[I.UserEditedInTable=0]="UserEditedInTable";I[I.FormulaByExampleNoTrigger=1]="FormulaByExampleNoTrigger";I[I.FlowInterrupted=2]="FlowInterrupted";I[I.FormulaByExampleFullTrigger=3]="FormulaByExampleFullTrigger";I[I.HadCachedSuggestion=4]="HadCachedSuggestion";I[I.NoCachedSuggestion=5]="NoCachedSuggestion";I[I.PreCalcPreviewRejected=6]="PreCalcPreviewRejected";I[I.WaitingForCalcResult=7]="WaitingForCalcResult";
I[I.PostCalcPreviewRejected=8]="PostCalcPreviewRejected";I[I.SuggestionDidntMatch=9]="SuggestionDidntMatch";I[I.SuggestionMatched=10]="SuggestionMatched";I[I.PreviewShouldBeShown=11]="PreviewShouldBeShown";I[I.SignalSent=12]="SignalSent";I[I.NoSignalSent=13]="NoSignalSent";I[I.AnnotationReceived=14]="AnnotationReceived";I[I.NoFormulaFound=15]="NoFormulaFound";I[I.FormulaFound=16]="FormulaFound";I[I.WorkbookClosed=17]="WorkbookClosed";I[I.UnexpectedTransition=18]="UnexpectedTransition"})(f||(f={}));
Object(r.b)("FormulaByExampleFlowState",f);const d=new Map([[f.UserEditedInTable,[f.FormulaByExampleNoTrigger,f.FormulaByExampleFullTrigger]],[f.FormulaByExampleFullTrigger,[f.FlowInterrupted,f.NoCachedSuggestion,f.HadCachedSuggestion]],[f.NoCachedSuggestion,[f.NoSignalSent,f.SignalSent]],[f.HadCachedSuggestion,[f.PreCalcPreviewRejected,f.WaitingForCalcResult]],[f.PreCalcPreviewRejected,[f.NoSignalSent,f.SignalSent]],[f.WaitingForCalcResult,[f.NoSignalSent,f.SignalSent]]]),h=new Set([f.FormulaByExampleNoTrigger,
f.FlowInterrupted,f.NoSignalSent,f.SignalSent]),l=new Map([[f.PreCalcPreviewRejected,[f.SuggestionDidntMatch,f.SuggestionMatched]]]),k=new Set([f.SuggestionDidntMatch,f.SuggestionMatched]),w=new Map([[f.WaitingForCalcResult,[f.PostCalcPreviewRejected,f.SuggestionDidntMatch,f.SuggestionMatched]],[f.SuggestionDidntMatch,[f.PostCalcPreviewRejected,f.PreviewShouldBeShown]],[f.SuggestionMatched,[f.PostCalcPreviewRejected,f.PreviewShouldBeShown]]]),n=new Set([f.PostCalcPreviewRejected,f.PreviewShouldBeShown]),
x=new Map([[f.SignalSent,[f.AnnotationReceived]],[f.AnnotationReceived,[f.NoFormulaFound,f.FormulaFound]],[f.FormulaFound,[f.PreCalcPreviewRejected,f.WaitingForCalcResult]]]),m=new Set([f.NoFormulaFound,f.FormulaFound]),u=new Set([f.NoFormulaFound,f.PreCalcPreviewRejected,f.WaitingForCalcResult]);var t;(function(I){I[I.Initial=0]="Initial";I[I.Pending=1]="Pending";I[I.Resolved=2]="Resolved"})(t||(t={}));Object(r.b)("SignalState",t);var y=a(155);class v{constructor(I,S,P){this.currentState=I;this.gTj=
S;this.uKh=P}Tua(I){const S=this.gTj.get(this.currentState);return S&&S.includes(I)?(this.currentState=I,!0):!1}get isActive(){return!this.uKh.has(this.currentState)}Bkd(){return f[this.currentState]}}Object(r.a)(v,"FormulaByExampleStateMachine",null,[]);class A{constructor(I,S,P,D,G){this.SWi=G;this.fsc=new v(0,d,h);this.b4={flowId:I,f$g:S,Wvj:P,Hgb:D,Woc:null,J_e:!1,DSd:!1,vTa:0,K_e:{},SCe:new Set}}get vTa(){return this.b4.vTa}set flowId(I){this.b4.flowId=I}Qpc(I){this.b4.SCe.add(I)}Tua(I,S){17===
I?this.Y9():(this.x$b(I,S),this.BTg())}Y9(){this.SWi(this.b4)}x$b(I,S){var P,D;this.fsc.Tua(I)?this.X0i(I):(null===(P=this.G0a)||void 0===P?0:P.Tua(I))?this.nTi(I):(null===(D=this.jBc)||void 0===D?0:D.Tua(I))?this.N3i(I,S):this.e_i(I,S);(I=this.I6e(I))&&this.Qqe(I,S)}X0i(I){switch(I){case 2:this.b4.J_e=!0;break;case 6:this.G0a=new v(I,l,k);break;case 7:this.G0a=new v(I,w,n);break;case 12:this.b4.vTa=1,this.jBc=new v(I,x,e.EwaSettings.isChangeGateEnabled("OfficeVSO:6169955_ShowFormulaByExampleSuggestionsUponArrivalFromServer")?
u:m)}}nTi(I){switch(I){case 9:this.b4.DSd=!1;break;case 10:this.b4.DSd=!0}}N3i(I,S){switch(I){case 14:this.b4.vTa=2;break;case 16:this.b4.Woc=S?S.Woc:null;break;case 7:this.G0a=new v(I,w,n)}}e_i(I,S){this.Qqe(this.I6e(18),{reason:`${`Tried to change state from ${this.gBj()} to ${f[I]}`}.${this.u8e(S)}`});this.Y9()}BTg(){var I,S;this.fsc.isActive||(null===(I=this.G0a)||void 0===I?0:I.isActive)||(null===(S=this.jBc)||void 0===S?0:S.isActive)||this.Y9()}Qqe(I,S){if(S=this.u8e(S))I.explanation||(I.explanation=
""),I.explanation+=S;S=I.name;I=Object(y.d)(I,["name"]);this.b4.K_e[S]=I}u8e(I){return null!=I&&null!=I.reason?" "+I.reason:""}gBj(){var I,S;const P=`OriginStateMachine: ${this.fsc.isActive?this.fsc.Bkd():"NotActive"}`,D=`CalcStateMachine: ${(null===(I=this.G0a)||void 0===I?0:I.isActive)?this.G0a.Bkd():"NotActive"}`;I=`SignalStateMachine: ${(null===(S=this.jBc)||void 0===S?0:S.isActive)?this.jBc.Bkd():"NotActive"}`;return`[${P}, ${D}, ${I}]`}I6e(I){switch(I){case 1:return this.kU("FBEFullTrigger",
!1);case 3:return this.kU("FBEFullTrigger",!0);case 5:return this.kU("CachedSuggestion",!1);case 4:return this.kU("CachedSuggestion",!0);case 6:return this.kU("PreviewShouldBeShown",!1,"Before calling calc evaluation");case 8:return this.kU("PreviewShouldBeShown",!1,"After returning from Calc");case 9:return this.kU("SetCellMatchedSuggestion",!1);case 10:return this.kU("SetCellMatchedSuggestion",!0);case 11:return this.kU("PreviewShouldBeShown",!0);case 8:return this.kU("PreviewShouldBeShown",!1,
"After returning from Calc");case 15:return this.kU("FormulaFound",!1);case 16:return this.kU("FormulaFound",!0);case 18:return this.kU("UnexpectedTransition",!0)}return null}kU(I,S,P){return P?{name:I,value:S,explanation:P}:{name:I,value:S}}}Object(r.a)(A,"FormulaByExampleFlowDataAggregator",null,[]);a.d(B,"b",function(){return-1});a.d(B,"a",function(){return z});class z{static getInstance(I){this.instance||(e.EwaSettings.isChangeGateEnabled("OfficeVSO:7041480_FormulaByExampleFlowAggregatorFixed")?
this.instance=C.getInstance(I):this.instance=H.getInstance(I));return this.instance}}Object(r.a)(z,"FormulaByExampleFlowsTrackerFactory",null,[]);class C{constructor(I){this.nextId=1;this.Shf=this.sQb=0;this.SU=new Map;this.rZd=new Map;this.eGe=new Map;this.yc=()=>{const S=this.D3h();if(0!==S.size){this.$.sendBeaconTraceTag(526984790,50,!1,`some pending FBE flows were not resolved by workbook closure. Total flows amount in sessions: ${this.sQb}, Unresolved flows amount: ${S.size}, pending flows: ${[...S].join()}, interrupted flows amount ${this.Shf}`);
for(const P of S)this.vp(P,17)}};this.GUj=S=>{const P=S.flowId;var D=S.f$g;const G=S.Wvj,E=S.Hgb,O=S.Woc,N=S.J_e,J=S.DSd,W=S.vTa,ea=S.K_e,R=S.SCe,Y=this.A7e(D);S=Y.Qrf;const U=S!==O;U&&(Y.Efg++,Y.Qrf=O);J&&Y.wQe++;N&&this.Shf++;2===W&&this.sQb++;D={["flowId"]:P,["columnKey"]:D,["rowNumber"]:G,["triggerCommand"]:Object(b.a)(E),["flowDataAggergation"]:ea,["editOperationsInColumn"]:Y.oQe,["suggestionChangesInColumn"]:Y.Efg,["gotNewSuggestion"]:U,["matchedSuggestionsInColumn"]:Y.wQe,["cellCycleColumns"]:Array.from(R).sort(),
["rowsEditedInColumn"]:Array.from(Y.uQe).sort()};c.ULS.sendTraceTag(512365781,0,null!=S||null!=O?20:50,`FormulaByExampleFlowsTracker.summarizeFlowOverallData: Flow Aggregation results: ${JSON.stringify(D)}`);this.SU.set(P,void 0)};this.$=I;this.$.ij(this.yc)}static getInstance(I){C.instance||(C.instance=new C(I));return C.instance}$6e(){const I=this.nextId++,S=this.SU.get(-1);S?(S.flowId=I,this.SU.set(I,S),this.SU.delete(-1)):c.ULS.sendTraceTag(512503829,0,15,`FormulaByExampleFlowsTracker.getNewFlowId: on flowId ${I} called getNewFlowId without having matched anonymousFlow`);
return I}Rkf(I){const S=this.SU.has(I),P=this.SU.get(I),D=P&&1===P.vTa;let G;S?P?D||(G="The flow exists but is not pending for annotation"):G="Flow was resolved already":G="This flow does not exist";G&&c.ULS.sendTraceTag(509650145,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: flow is not pending for annotation. ${G} flowId: ${I}`);return D}FEf(I,S,P,D){this.SU.get(-1)&&(this.vp(-1,2),this.SU.delete(-1));S=this.oVh(S,P);P=this.A7e(S);P.oQe++;P.uQe.add(D);this.SU.set(-1,new A(-1,
S,D,I,this.GUj))}Qpc(I,S){const P=this.SU.get(I);P?P.Qpc(S):this.U_f("onCellCycleFound",I)}vp(I,S,P){const D=this.SU.get(I);D?D.Tua(S,P):this.U_f("notifyFlowReachedState",I,S)}oVh(I,S){let P=this.rZd.get(I);void 0===P&&(P=this.rZd.size,this.rZd.set(I,P));return P+"_"+S}D3h(){const I=new Set;for(const [S,P]of this.SU)1===(null===P||void 0===P?void 0:P.vTa)&&I.add(S);return I}A7e(I){let S=this.eGe.get(I);S||(S={oQe:0,wQe:0,Efg:0,Qrf:null,uQe:new Set},this.eGe.set(I,S));return S}U_f(I,S,P){const D=this.SU.has(S);
c.ULS.sendTraceTag(509678805,0,15,`FormulaByExampleFlowsTracker.${I}:
       on flowId ${S} ${P?` transition to ${f[P]}`:""}, `+"flowIdsToAggregatorsMap didn't find the requested flowAggregatoror. "+`Did flow exist: ${D}`)}}Object(r.a)(C,"FormulaByExampleFlowsTracker",null,[288]);class H{constructor(I){this.nextId=1;this.wwb=new Set;this.sQb=0;this.yc=()=>{let S=this.wwb.size;0!==S&&this.$.sendBeaconTraceTag(526984790,50,!1,"some pending FBE flows were not resolved by workbook closure. Total flows amount in sessions: {0}, Unresolved flows amount: {1}, pending flows: {2}",
this.sQb,S,[...this.wwb].join())};this.$=I;this.$.ij(this.yc)}static getInstance(I){H.instance||(H.instance=new H(I));return H.instance}Rkf(I){return this.wwb.has(I)}FEf(){}Qpc(){}vp(I,S){switch(S){case 12:this.xDj(I);break;case 14:this.yDj(I)}}$6e(){return this.nextId++}xDj(I){this.wwb.add(I);this.sQb++}yDj(I){this.wwb.delete(I)}}Object(r.a)(H,"FormulaByExampleFlowsTrackerDeprecated",null,[288])},894:function(r,B,a){a.d(B,"a",function(){return 2})}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDSEsNext.augmentationloop.js.map/a5c5fafafe7aad781f06b6a9b8c69b46/EwaDSEsNext.augmentationloop.js.map